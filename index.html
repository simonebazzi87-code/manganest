<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest Cloud Debug</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:sans-serif;background:#f5f6fa;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);max-width:400px;margin:auto}
input{width:100%;padding:12px;margin:10px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
button{width:100%;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;margin-top:10px}
.ok{background:var(--main);color:white}
.save{background:#2d3436;color:white}
.status{margin-top:20px;padding:10px;border-radius:6px;display:none;font-size:13px}
</style>
</head>
<body>

<div class="card">
    <h2>☁️ Sincronizzazione</h2>
    <p style="font-size:13px;color:#666">Inserisci le chiavi di GitHub</p>
    
    <input id="tk" type="password" placeholder="GitHub Token (ghp_...)">
    <input id="gid" placeholder="Gist ID">
    
    <button class="save" onclick="salva()">1. Salva Chiavi</button>
    <hr>
    <button class="ok" onclick="test( 'UPLOAD' )">2. Prova Invia (Upload)</button>
    <button class="ok" style="background:#00b894" onclick="test( 'DOWNLOAD' )">3. Prova Ricevi (Download)</button>
    
    <div id="stat" class="status"></div>
</div>

<script>
// Carica dati esistenti
let config = JSON.parse(localStorage.getItem("manga_cloud")) || { token: "", id: "" };
document.getElementById('tk').value = config.token;
document.getElementById('gid').value = config.id;

function salva() {
    config.token = document.getElementById('tk').value.trim();
    config.id = document.getElementById('gid').value.trim();
    localStorage.setItem("manga_cloud", JSON.stringify(config));
    alert("Chiavi salvate localmente!");
}

async function test(mode) {
    const s = document.getElementById('stat');
    s.style.display = "block";
    s.style.background = "#eee";
    s.textContent = "Connessione in corso...";

    const token = config.token;
    const gistId = config.id;

    try {
        if(mode === 'UPLOAD') {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({
                    files: { "data.json": { content: JSON.stringify({test: "funziona", date: new Date()}) } }
                })
            });

            if(res.ok) {
                s.style.background = "#dff9fb";
                s.textContent = "✅ TOKEN VALIDO! L'invio ha funzionato.";
            } else {
                const err = await res.json();
                s.style.background = "#fab1a0";
                s.textContent = "❌ ERRORE: " + err.message + " (Controlla il Token!)";
            }
        } else {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                s.style.background = "#dff9fb";
                s.textContent = "✅ TOKEN VALIDO! Il download ha funzionato.";
            } else {
                const err = await res.json();
                s.textContent = "❌ ERRORE: " + err.message;
            }
        }
    } catch (e) {
        s.textContent = "❌ Errore di rete: " + e.message;
    }
}
</script>
</body>
</html>
