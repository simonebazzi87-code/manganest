<script>
/* ================= DATABASE & CLOUD ================= */
let db = JSON.parse(localStorage.getItem("manganest_v5")) || {
  users: [{id: "u1", name: "Simone", color: "#0984e3", groupId: "default"},{id: "u2", name: "Andrea", color: "#e84393", groupId: "default"}],
  groups: [{id: "default", name: "Casa"}],
  currentUser: null, sagas: [], series: [], volumes: [], read: [],
  cloud: { token: "", gistId: "" } // Dati per GitHub
};

const save = () => localStorage.setItem("manganest_v5", JSON.stringify(db));

/* FUNZIONI CLOUD */
async function syncCloud(mode) {
    if (!db.cloud.token || !db.cloud.gistId) {
        const t = prompt("Inserisci il tuo GitHub Token:");
        const id = prompt("Inserisci il tuo Gist ID:");
        if (t && id) { db.cloud.token = t; db.cloud.gistId = id; save(); }
        else return;
    }

    const btn = document.getElementById("syncBtn");
    const originalText = btn.textContent;
    btn.textContent = "⌛ Attendi...";
    btn.disabled = true;

    try {
        if (mode === 'UPLOAD') {
            // CARICA SULLA NUVOLA
            const response = await fetch(`https://api.github.com/gists/${db.cloud.gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${db.cloud.token}` },
                body: JSON.stringify({ files: { "data.json": { content: JSON.stringify(db) } } })
            });
            if (response.ok) alert("✅ Dati salvati sul Cloud!");
            else throw new Error();
        } else {
            // SCARICA DALLA NUVOLA
            const response = await fetch(`https://api.github.com/gists/${db.cloud.gistId}`, {
                headers: { 'Authorization': `token ${db.cloud.token}` }
            });
            const data = await response.json();
            const remoteDb = JSON.parse(data.files["data.json"].content);
            if (confirm("Vuoi sovrascrivere i dati locali con quelli del Cloud?")) {
                db = remoteDb;
                save();
                render();
                alert("✅ Dati aggiornati con successo!");
            }
        }
    } catch (e) {
        alert("❌ Errore di sincronizzazione. Verifica Token e ID.");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Nel menu render(), ho aggiunto il tasto Cloud
function render(){
  // ... (codice utente e colori invariato) ...
  
  menu.innerHTML = "";
  if(!db.currentUser){home(); return;}
  
  // Tasti normali
  [["Database",searchDB],["Edicola",edicolaTab],["Lettura",readTab],["Aggiungi",addVolumes],["Serie",addSeries],["Utenti",users]].forEach(([t,f])=>{
    const b = document.createElement("button");
    b.textContent = t; b.onclick = () => f(app); menu.appendChild(b);
  });

  // Tasto Cloud (Speciale)
  const cloudBtn = document.createElement("button");
  cloudBtn.id = "syncBtn";
  cloudBtn.textContent = "☁️ Cloud";
  cloudBtn.style.background = "#2d3436";
  cloudBtn.style.color = "white";
  cloudBtn.onclick = () => showCloudMenu();
  menu.appendChild(cloudBtn);

  searchDB(app);
}

function showCloudMenu() {
    app.innerHTML = `
        <h2 class="section-title">Sincronizzazione Cloud</h2>
        <div class="card">
            <p>Usa GitHub per sincronizzare i dati tra più dispositivi.</p>
            <button class="ok" style="width:100%; margin-bottom:10px" onclick="syncCloud('UPLOAD')">⬆️ Invia dati al Cloud</button>
            <button class="ok" style="width:100%; background:#00b894" onclick="syncCloud('DOWNLOAD')">⬇️ Scarica dati dal Cloud</button>
            <hr>
            <p class="small">Impostazioni:</p>
            <input id="clToken" type="password" placeholder="GitHub Token" value="${db.cloud.token}">
            <input id="clId" placeholder="Gist ID" value="${db.cloud.gistId}">
            <button onclick="saveCloudSettings()" style="width:100%; padding:5px">Salva Chiavi</button>
            <button class="danger" style="width:100%; margin-top:10px; font-size:11px" onclick="resetCloud()">Reset Chiavi</button>
        </div>
    `;
}

window.saveCloudSettings = () => {
    db.cloud.token = document.getElementById("clToken").value;
    db.cloud.gistId = document.getElementById("clId").value;
    save();
    alert("Chiavi salvate!");
}

window.resetCloud = () => {
    if(confirm("Eliminare le chiavi di accesso?")) {
        db.cloud.token = ""; db.cloud.gistId = ""; save(); showCloudMenu();
    }
}

/* ... (Il resto del codice rimane identico al checkpoint salvato) ... */
</script>
