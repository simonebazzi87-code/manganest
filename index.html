<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest - Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:system-ui;background:#f5f6fa}
header{background:var(--main);color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;border-bottom:1px solid #ddd}
nav button{height:40px;border:none;border-radius:6px;padding:0 14px;cursor:pointer;background:#eee}
nav button.active{background:var(--main);color:#fff}
main{padding:12px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid #eee}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;border-bottom:1px solid #eee}
.cover{width:70px;height:100px;object-fit:cover;border-radius:4px;background:#ccc}
.small{font-size:12px;color:#555}
input,select{padding:8px;margin:4px 0;width:100%;border:1px solid #ccc;border-radius:4px}
.ok{background:var(--main);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer}
.danger{background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer}
.volumeBtn{margin:2px;padding:6px 10px;border-radius:6px;border:none;background:#eee;cursor:pointer}
.volumeBtn:hover{background:#ff7675;color:white} /* Feedback eliminazione */
.edit-box{background:#f9f9f9;padding:10px;margin-top:10px;border-left:4px solid var(--main)}
</style>
</head>

<body>
<header>
  <h2>MangaNest</h2>
  <div><span id="who"></span> <button id="switchUser" style="display:none;font-size:10px">Esci</button></div>
</header>

<nav id="menu"></nav>
<main id="app"></main>

<script>
let db = JSON.parse(localStorage.getItem("manganest")) || {
  users:[], currentUser:null, sagas:[], series:[], volumes:[]
};
const save=()=>localStorage.setItem("manganest",JSON.stringify(db));

const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

switchBtn.onclick=()=>{db.currentUser=null;render()};

function render(){
  const u=db.users.find(u=>u.id===db.currentUser);
  document.documentElement.style.setProperty("--main",u?.color||"#6c5ce7");
  who.textContent=u?`Ciao, ${u.name}`:"";
  switchBtn.style.display=u?"inline":"none";
  menu.innerHTML="";
  if(!db.currentUser){home();return;}

  [["Aggiungi serie",addSeries],["Aggiungi numeri",addVolumes],["Database",searchDB],["Utenti",users]].forEach(([t,f])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.onclick=()=>f(app);
    menu.appendChild(b);
  });
  addSeries(app);
}

function home(){
  app.innerHTML="<h3>Scegli utente</h3>";
  db.users.forEach(u=>{
    const b=document.createElement("button");
    b.textContent=u.name; b.style.background=u.color; b.className="ok"; b.style.margin="5px";
    b.onclick=()=>{db.currentUser=u.id;save();render()};
    app.appendChild(b);
  });
}

/* ================= 1. AGGIUNGI / EDIT SERIE ================= */
function addSeries(c){
  c.innerHTML="<h2>Gestione Serie & Saghe</h2>";
  
  // Sezione Nuova Saga
  let h = `<div class="card"><h3>Crea Saga</h3><input id="newSagaName" placeholder="Nome Saga"><button class="ok" onclick="createSaga()">Crea</button></div>`;
  
  // Sezione Nuova Serie
  h += `<div class="card"><h3>Nuova Serie</h3>
    <input id="nsTitolo" placeholder="Titolo">
    <select id="nsSaga"><option value="">Saga: Stesso nome serie</option>
    ${db.sagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
    <input id="nsAutore" placeholder="Autori"><input id="nsEditore" placeholder="Editore"><input id="nsImg" placeholder="URL Immagine">
    <button class="ok" onclick="createSerie()">Salva Serie</button></div>`;

  // ELENCO PER MODIFICA
  h += `<h3>Modifica Esistenti</h3>`;
  db.sagas.forEach(sg=>{
    h += `<div class="card" style="border-left:5px solid #636e72">
      <div class="row"><b>Saga:</b> <input style="width:auto" value="${sg.name}" onchange="updateSaga('${sg.id}', this.value)"> 
      <button class="danger" onclick="deleteSaga('${sg.id}')">Elimina Saga</button></div>`;
    
    db.series.filter(s=>s.sagaId===sg.id).forEach(sr=>{
      h += `<div class="edit-box">
        <input value="${sr.name}" onchange="updateSerie('${sr.id}','name',this.value)" placeholder="Titolo">
        <select onchange="updateSerie('${sr.id}','sagaId',this.value)">
          ${db.sagas.map(s=>`<option value="${s.id}" ${s.id===sr.sagaId?'selected':''}>Sposta in: ${s.name}</option>`).join('')}
        </select>
        <input value="${sr.authors}" onchange="updateSerie('${sr.id}','authors',this.value)" placeholder="Autori">
        <button class="danger" style="font-size:10px;margin-top:5px" onclick="deleteSerie('${sr.id}')">Elimina Serie</button>
      </div>`;
    });
    h += `</div>`;
  });
  c.innerHTML += h;
}

window.createSaga=()=>{
  const name=document.getElementById("newSagaName").value;
  if(!name)return; db.sagas.push({id:crypto.randomUUID(), name}); save(); render();
}
window.createSerie=()=>{
  const name=document.getElementById("nsTitolo").value;
  if(!name)return;
  let sagaId=document.getElementById("nsSaga").value;
  if(!sagaId){ const ns={id:crypto.randomUUID(),name}; db.sagas.push(ns); sagaId=ns.id; }
  db.series.push({id:crypto.randomUUID(), name, sagaId, authors:document.getElementById("nsAutore").value, publisher:document.getElementById("nsEditore").value, img:document.getElementById("nsImg").value});
  save(); render();
}
window.updateSaga=(id,v)=>{ const s=db.sagas.find(x=>x.id===id); if(s)s.name=v; save(); }
window.updateSerie=(id,f,v)=>{ const s=db.series.find(x=>x.id===id); if(s)s[f]=v; save(); }
window.deleteSaga=(id)=>{ if(confirm("Eliminare saga e scollegare serie?")){db.sagas=db.sagas.filter(x=>x.id!==id); save(); render();}}
window.deleteSerie=(id)=>{ if(confirm("Eliminare serie e tutti i suoi volumi?")){db.series=db.series.filter(x=>x.id!==id); db.volumes=db.volumes.filter(v=>v.seriesId!==id); save(); render();}}

/* ================= 2. AGGIUNGI / ELIMINA NUMERI ================= */
function addVolumes(c){
  c.innerHTML=`<h2>Aggiungi numeri</h2><div class="card">
    <select id="vSerie">${db.series.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
    <input type="number" id="vStart" placeholder="Dal"> <input type="number" id="vEnd" placeholder="Al">
    <button class="ok" onclick="saveVols()">Aggiungi</button></div><div id="vList"></div>`;
  showUserVols();
}

window.saveVols=()=>{
  const sid=document.getElementById("vSerie").value, start=Number(document.getElementById("vStart").value), end=Number(document.getElementById("vEnd").value)||start;
  for(let i=start;i<=end;i++) if(!db.volumes.find(v=>v.seriesId===sid && v.number===i && v.userId===db.currentUser)) db.volumes.push({id:crypto.randomUUID(), seriesId:sid, number:i, userId:db.currentUser});
  save(); showUserVols();
}

function showUserVols(){
  const sid=document.getElementById("vSerie").value;
  const sr=db.series.find(x=>x.id===sid);
  const cont=document.getElementById("vList");
  if(!sr){cont.innerHTML=""; return;}
  const myVols=db.volumes.filter(v=>v.seriesId===sid && v.userId===db.currentUser).sort((a,b)=>a.number-b.number);
  cont.innerHTML=`<div class="card"><h4>${sr.name} - I tuoi volumi (clicca per eliminare)</h4>
    ${myVols.map(v=>`<button class="volumeBtn" onclick="removeVol('${v.id}')">${v.number}</button>`).join('')}</div>`;
}

window.removeVol=(id)=>{ db.volumes=db.volumes.filter(v=>v.id!==id); save(); showUserVols(); }

/* ================= 3. DATABASE (RICERCA GLOBALE) ================= */
function searchDB(c){
  c.innerHTML=`<h2>Database Globale</h2><div class="card">
    <select id="searchSaga"><option value="">Tutte le saghe</option>${db.sagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
    <button class="ok" onclick="doSearch()">Ricerca</button></div><div id="searchRes"></div>`;
}

window.doSearch=()=>{
  const sid=document.getElementById("searchSaga").value;
  const res=document.getElementById("searchRes");
  let filteredSagas = sid ? db.sagas.filter(s=>s.id===sid) : db.sagas;
  
  res.innerHTML = filteredSagas.map(sg=>{
    const series = db.series.filter(r=>r.sagaId===sg.id);
    return `<div class="card"><h3>Saga: ${sg.name}</h3>
      ${series.map(sr=>{
        // Prendi tutti i numeri di questa serie, indipendentemente dall'utente, e togli i duplicati
        const allNums = [...new Set(db.volumes.filter(v=>v.seriesId===sr.id).map(v=>v.number))].sort((a,b)=>a-b);
        return `<div class="row">
          <img src="${sr.img||'https://via.placeholder.com/70x100'}" class="cover">
          <div><b>${sr.name}</b><br><span class="small">${sr.authors} | ${sr.publisher}</span><br>
          <div style="margin-top:5px">Num. presenti: ${allNums.join(", ") || 'Nessuno'}</div></div>
        </div>`;
      }).join('')}</div>`;
  }).join('');
}

/* ================= 4. UTENTI ================= */
function users(c){
  c.innerHTML="<h2>Utenti</h2>";
  db.users.forEach(u=>{
    c.innerHTML+=`<div class="card"><input value="${u.name}" onchange="updateU('${u.id}',this.value)"></div>`;
  });
}
window.updateU=(id,v)=>{ const u=db.users.find(x=>x.id===id); if(u)u.name=v; save(); render(); }

render();
</script>
</body>
</html>
