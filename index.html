<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest - Simone & Andrea</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:system-ui;background:#f5f6fa}
header{background:var(--main);color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;border-bottom:1px solid #ddd}
nav button{height:40px;border:none;border-radius:6px;padding:0 14px;cursor:pointer;background:#eee;font-weight:bold}
nav button.active{background:var(--main);color:#fff}
main{padding:12px; padding-bottom:100px}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:12px;border:1px solid #eee;box-shadow: 0 2px 4px rgba(0,0,0,0.05)}
.row-edit{display:flex;gap:15px;align-items:flex-start;padding:10px;border-bottom:1px solid #eee; flex-wrap: wrap;}
.cover-big{width:100px; height:150px; object-fit:cover; border-radius:8px; background:#ccc; border:1px solid #ddd;}
input,select{padding:10px;margin:5px 0;width:100%;border:1px solid #ccc;border-radius:6px; box-sizing: border-box;}
.ok{background:var(--main);color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold}
.danger{background:#e74c3c;color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold}
.vol-container { display: flex; flex-direction: column; align-items: center; margin: 4px; }
.volumeStatic{padding:5px 12px;border-radius:6px;border:1.5px solid #eee;background:#fff;display:inline-block;font-size:14px;font-weight:bold;text-align:center}
.volumeBtn{padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#f9f9f9;cursor:pointer;font-weight:bold}
.m-label{font-size:10px; font-weight:bold; margin-top:2px; text-transform:uppercase}
.read-indicators { display: flex; gap: 3px; height: 8px; margin-top: 4px; justify-content: center; min-height:8px; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }
.section-title{border-left: 4px solid var(--main); padding-left: 10px; margin: 20px 0 10px 0; color: #2d3436}
.small{font-size:12px; color:#666}
</style>
</head>

<body>
<header>
  <h2>MangaNest <span id="groupLabel" style="font-size:12px; opacity:0.8"></span></h2>
  <div><span id="who"></span> <button id="switchUser" style="display:none;font-size:10px;margin-left:10px">Esci</button></div>
</header>
<nav id="menu"></nav>
<main id="app"></main>

<script>
/* ================= DATABASE ================= */
let db = JSON.parse(localStorage.getItem("manganest_v5")) || {
  users: [
    {id: "u1", name: "Simone", color: "#0984e3", groupId: "default"},
    {id: "u2", name: "Andrea", color: "#e84393", groupId: "default"}
  ],
  groups: [{id: "default", name: "Casa"}],
  currentUser: null,
  sagas: [], series: [], volumes: [], read: []
};

const save=()=>localStorage.setItem("manganest_v5",JSON.stringify(db));
const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

let edMode = "ALL"; 

switchBtn.onclick=()=>{db.currentUser=null; save(); render();};

function getActiveGroup() {
    const u = db.users.find(u => u.id === db.currentUser);
    return u ? u.groupId : "default";
}

function render(){
  const u = db.users.find(u => u.id === db.currentUser);
  if(u) document.documentElement.style.setProperty("--main", u.color);
  who.textContent = u ? `Utente: ${u.name}` : "";
  const group = db.groups.find(g => g.id === (u?.groupId || "default"));
  document.getElementById("groupLabel").textContent = u ? `[Gruppo: ${group.name}]` : "";
  switchBtn.style.display = u ? "inline" : "none";
  menu.innerHTML = "";
  if(!db.currentUser){home(); return;}
  
  [["Database",searchDB],["Edicola",edicolaTab],["Lettura",readTab],["Aggiungi",addMenu],["Utenti",users],["Backup",backupMenu]].forEach(([t,f])=>{
    const b = document.createElement("button");
    b.textContent = t; b.onclick = () => f(app); menu.appendChild(b);
  });
  searchDB(app);
}

function home(){
  app.innerHTML = "<h3 style='text-align:center; margin-top:50px'>Chi sei?</h3><div id='userList' style='display:flex; justify-content:center; flex-wrap:wrap; gap:10px'></div>";
  db.users.forEach(u=>{
    const b = document.createElement("button");
    b.textContent = u.name; b.style.background = u.color; b.className = "ok"; b.style.padding = "20px 30px";
    b.onclick = () => { db.currentUser = u.id; save(); render(); };
    document.getElementById('userList').appendChild(b);
  });
}

/* ================= CATALOGO, EDICOLA, LETTURA ================= */
function searchDB(c){
  const gid=getActiveGroup(); 
  c.innerHTML=`<h2 class="section-title">Catalogo</h2><div id="searchRes"></div>`;
  const sS = db.series.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name));
  document.getElementById("searchRes").innerHTML = sS.map(sr => {
      const aN = db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===gid).map(v=>v.number).sort((a,b)=>a-b);
      return `<div class="card"><div class="row-edit" style="border:none"><img src="${sr.img}" class="cover-big" onerror="this.src='https://via.placeholder.com/100x150?text=No+Cover'"><div><b style="font-size:18px">${sr.name}</b><br><div style="margin-top:10px">${aN.map(n=>`<span class="volumeStatic" style="margin:2px">${n}</span>`).join('')}</div></div></div></div>`;
  }).join('') || '<div class="card">Nessun manga trovato.</div>';
}

function edicolaTab(c){
  const gid = getActiveGroup();
  const user = db.users.find(u => u.id === db.currentUser);
  c.innerHTML = `<h2 class="section-title">Edicola</h2><div id="edicolaList"></div>`;
  let h = "";
  db.series.filter(s => s.groupId === gid).sort((a,b)=>a.name.localeCompare(b.name)).forEach(sr => {
    const groupVols = db.volumes.filter(v => v.seriesId === sr.id && v.groupId === gid).map(v=>v.number);
    const max = groupVols.length > 0 ? Math.max(...groupVols) : 0;
    let gaps = []; for(let i=1; i<max; i++) if(!groupVols.includes(i)) gaps.push(i);
    let next = (sr.status === "In Corso" || max === 0) ? max + 1 : null;

    if(gaps.length > 0 || next) {
        h += `<div class="card"><b>${sr.name}</b><div style="display:flex; flex-wrap:wrap; margin-top:10px">
            ${gaps.map(n => `<div class="vol-container"><span class="volumeStatic" style="border-color:${user.color}; color:${user.color}">${n}</span><span class="m-label" style="color:${user.color}">Mancante</span></div>`).join('')}
            ${next ? `<div class="vol-container"><span class="volumeStatic" style="border-color:#27ae60; color:#333">${next}</span><span class="m-label" style="color:#27ae60">Nuovo</span></div>` : ''}
        </div></div>`;
    }
  });
  document.getElementById("edicolaList").innerHTML = h || `<div class="card">Tutto aggiornato!</div>`;
}

function readTab(c){
  const gid=getActiveGroup();
  const user=db.users.find(u=>u.id===db.currentUser);
  const groupMembers = db.users.filter(u => u.groupId === user.groupId);
  c.innerHTML=`<h2 class="section-title">Lettura</h2><div id="readArea"></div>`;
  document.getElementById("readArea").innerHTML = db.series.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name)).map(sr=>{
    const myVols=db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===gid).sort((a,b)=>a.number-b.number);
    return `<div class="card"><h3>${sr.name}</h3><div style="display:flex;flex-wrap:wrap">${myVols.map(v=>{
        const dots = groupMembers.map(m => db.read.some(r=>r.volId===v.id && r.userId===m.id) ? `<span class="dot" style="background:${m.color}"></span>` : '').join('');
        const amIRead=db.read.some(r=>r.volId===v.id && r.userId===user.id);
        return `<div class="vol-container"><button class="volumeBtn" style="${amIRead?`background:${user.color};color:white;border:none`:''}" onclick="toggleRead('${v.id}')">${v.number}</button><div class="read-indicators">${dots}</div></div>`;
    }).join('')}</div></div>`;
  }).join('');
}
window.toggleRead=(volId)=>{ const idx=db.read.findIndex(r=>r.volId===volId && r.userId===db.currentUser); if(idx>-1) db.read.splice(idx,1); else db.read.push({volId, userId:db.currentUser}); save(); readTab(app); }

/* ================= AGGIUNTA SERIE E VOLUMI ================= */
function addMenu(c){
  const gid = getActiveGroup();
  const series = db.series.filter(s => s.groupId === gid).sort((a,b)=>a.name.localeCompare(b.name));
  c.innerHTML=`<h2 class="section-title">Aggiungi Numeri</h2>
    <div class="card"><select id="vSerie"><option value="">-- Seleziona Serie --</option>${series.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
    <input type="number" id="vStart" placeholder="Dal n."><input type="number" id="vEnd" placeholder="Al n. (opzionale)"><button class="ok" style="width:100%; margin-top:10px" onclick="saveVols()">Aggiungi</button></div>
    <h2 class="section-title">Nuova Serie</h2>
    <div class="card"><input id="nsTitolo" placeholder="Titolo"><input id="nsAutore" placeholder="Autore"><input id="nsImg" placeholder="URL Immagine"><select id="nsStatus"><option value="In Corso">In Corso</option><option value="Terminata">Terminata</option></select><button class="ok" onclick="createSerieFull()">Crea</button></div>`;
}
window.saveVols=()=>{
  const sid=document.getElementById("vSerie").value, start=Number(document.getElementById("vStart").value), end=Number(document.getElementById("vEnd").value)||start;
  if(!sid || !start) return;
  for(let i=start;i<=end;i++) if(!db.volumes.find(v=>v.seriesId===sid && v.number===i && v.groupId===getActiveGroup())) db.volumes.push({id:crypto.randomUUID(), seriesId:sid, number:i, groupId:getActiveGroup()});
  save(); alert("Aggiunti!"); render();
}
window.createSerieFull=()=>{
  const name=document.getElementById("nsTitolo").value.trim(); if(!name)return;
  const gid=getActiveGroup();
  db.series.push({id:crypto.randomUUID(), name, groupId:gid, authors:document.getElementById("nsAutore").value, img:document.getElementById("nsImg").value, status:document.getElementById("nsStatus").value});
  save(); render();
}

/* ================= UTENTI E RESET ================= */
function users(c){
  c.innerHTML = `<h2 class="section-title">Profili Utenti</h2>`;
  db.users.forEach(u => {
    c.innerHTML += `<div class="card"><input id="un-${u.id}" value="${u.name}"> <input id="uc-${u.id}" type="color" value="${u.color}"><button class="ok" style="margin-top:10px" onclick="updateUserProfile('${u.id}')">Salva</button></div>`;
  });
  
  c.innerHTML += `
    <h2 class='section-title' style='color:#e74c3c'>Impostazioni di Fabbrica</h2>
    <div class='card' style="border: 1px solid #e74c3c">
      <p class='small'><b>ATTENZIONE:</b> Questa azione elimina TUTTO (Saghe, Serie, Volumi, Letture, Gruppi e Utenti creati). Il sito tornerà vuoto.</p>
      <button class="danger" style="width:100%" onclick="fullResetStep1()">ELIMINA TUTTO IL SITO</button>
    </div>`;
}

window.updateUserProfile=(id)=>{ 
  const u=db.users.find(x=>x.id===id); u.name=document.getElementById(`un-${id}`).value; u.color=document.getElementById(`uc-${id}`).value; save(); render(); 
}

window.fullResetStep1 = () => { if(confirm("SEI SICURO? Perderai tutti i dati inseriti da te e Andrea.")){ fullResetStep2(); } }
window.fullResetStep2 = () => { if(confirm("CONFERMA FINALE: Il sito verrà riportato alle impostazioni di fabbrica. Procedere?")){ localStorage.removeItem("manganest_v5"); alert("Sito resettato."); location.reload(); } }

/* ================= BACKUP (IMPORTA/ESPORTA) ================= */
function backupMenu(c){
    c.innerHTML = `
        <h2 class="section-title">Backup & Ripristino</h2>
        <div class="card">
            <h3>Esporta Dati</h3>
            <p class="small">Salva un file con tutta la tua collezione per passarla su un altro dispositivo.</p>
            <button class="ok" style="background:#0984e3; width:100%" onclick="exportDB()">Scarica File Backup</button>
        </div>
        <div class="card">
            <h3>Importa Dati</h3>
            <p class="small">Seleziona un file di backup per sovrascrivere i dati attuali.</p>
            <input type="file" id="importFile" accept=".json" style="margin-bottom:10px">
            <button class="ok" style="background:#00b894; width:100%" onclick="importDB()">Ripristina da File</button>
        </div>`;
}

window.exportDB = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "manganest_backup.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

window.importDB = () => {
    const file = document.getElementById('importFile').files[0];
    if (!file) { alert("Seleziona prima un file!"); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (imported.users && imported.series) {
                if(confirm("L'importazione sovrascriverà tutti i dati attuali. Continuare?")) {
                    db = imported;
                    save();
                    location.reload();
                }
            } else { alert("File non valido!"); }
        } catch (err) { alert("Errore durante la lettura del file."); }
    };
    reader.readAsText(file);
}

render();
</script>
</body>
</html>
