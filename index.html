<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest - Checkpoint Finale</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:system-ui;background:#f5f6fa}
header{background:var(--main);color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;border-bottom:1px solid #ddd}
nav button{height:40px;border:none;border-radius:6px;padding:0 14px;cursor:pointer;background:#eee}
nav button.active{background:var(--main);color:#fff}
main{padding:12px}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:12px;border:1px solid #eee;box-shadow: 0 2px 4px rgba(0,0,0,0.05)}
.row-edit{display:flex;gap:15px;align-items:flex-start;padding:10px;border-bottom:1px solid #eee; flex-wrap: wrap;}
.cover-big{width:100px; height:150px; object-fit:cover; border-radius:8px; background:#ccc; border:1px solid #ddd;}
input,select{padding:10px;margin:5px 0;width:100%;border:1px solid #ccc;border-radius:6px; box-sizing: border-box;}
.ok{background:var(--main);color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold}
.danger{background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
.vol-container { display: flex; flex-direction: column; align-items: center; margin: 4px; }
.volumeStatic{padding:5px 12px;border-radius:6px;border:1.5px solid #eee;background:#fff;display:inline-block;font-size:14px;font-weight:bold;text-align:center}
.m-label{font-size:10px; font-weight:bold; margin-top:2px; text-transform:uppercase}
.read-indicators { display: flex; gap: 3px; height: 8px; margin-top: 4px; justify-content: center; min-height:8px; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }
.section-title{border-left: 4px solid var(--main); padding-left: 10px; margin: 20px 0 10px 0; color: #2d3436}
.buy-tag{background:#27ae60; color:white; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:bold; height:fit-content}
.small{font-size:12px; color:#666}
</style>
</head>
<body>

<header>
  <h2>MangaNest <span id="groupLabel" style="font-size:12px; opacity:0.8"></span></h2>
  <div><span id="who"></span> <button id="switchUser" style="display:none;font-size:10px;margin-left:10px">Esci</button></div>
</header>
<nav id="menu"></nav>
<main id="app"></main>

<script>
/* ================= DATABASE ================= */
let db = JSON.parse(localStorage.getItem("manganest_v5")) || {
  users: [
    {id: "u1", name: "Simone", color: "#0984e3", groupId: "default"},
    {id: "u2", name: "Andrea", color: "#e84393", groupId: "default"}
  ],
  groups: [{id: "default", name: "Casa"}],
  currentUser: null, sagas: [], series: [], volumes: [], read: [],
  cloud: { token: "", gistId: "" }
};

const save = () => localStorage.setItem("manganest_v5", JSON.stringify(db));
const app = document.getElementById("app");

/* ================= CLOUD SYNC ================= */
async function syncCloud(mode) {
    if (!db.cloud.token || !db.cloud.gistId) { alert("Configura le chiavi!"); return; }
    const tk = db.cloud.token.trim().replace(/\s/g, '');
    const gid = db.cloud.gistId.trim().replace(/\s/g, '');
    const btn = document.getElementById("syncBtnMain");
    if(btn) { btn.disabled = true; btn.textContent = "‚åõ..."; }

    try {
        const headers = { 'Authorization': `token ${tk}`, 'Accept': 'application/vnd.github.v3+json' };
        if (mode === 'UPLOAD') {
            const res = await fetch(`https://api.github.com/gists/${gid}`, {
                method: 'PATCH', headers: headers,
                body: JSON.stringify({ files: { "data.json": { content: JSON.stringify(db) } } })
            });
            if (res.ok) alert("‚úÖ Dati inviati!"); else alert("Errore: " + (await res.json()).message);
        } else {
            const res = await fetch(`https://api.github.com/gists/${gid}?cb=${Date.now()}`, { headers: headers });
            if (!res.ok) throw new Error((await res.json()).message);
            const data = await res.json();
            db = JSON.parse(data.files["data.json"].content);
            save(); render(); alert("‚úÖ Sincronizzazione completata!");
        }
    } catch (e) { alert("‚ùå Errore: " + e.message); }
    finally { if(btn) { btn.disabled = false; btn.textContent = "‚òÅÔ∏è Cloud"; } }
}

function showCloudMenu() {
    app.innerHTML = `
        <h2 class="section-title">Cloud Sync</h2>
        <div class="card">
            <button class="ok" style="width:100%; margin-bottom:10px" onclick="syncCloud('UPLOAD')">‚¨ÜÔ∏è Invia al Cloud</button>
            <button class="ok" style="width:100%; background:#00b894; margin-bottom:20px" onclick="syncCloud('DOWNLOAD')">‚¨áÔ∏è Scarica dal Cloud</button>
            <hr>
            <p class="small">Token GitHub (ghp_...):</p>
            <div style="display:flex; gap:5px">
                <input id="clToken" type="password" value="${db.cloud.token}">
                <button onclick="document.getElementById('clToken').type=(document.getElementById('clToken').type==='password'?'text':'password')" style="width:45px; border-radius:6px; border:1px solid #ccc; margin:5px 0">üëÅÔ∏è</button>
            </div>
            <p class="small">Gist ID:</p>
            <input id="clId" value="${db.cloud.gistId}">
            <button class="ok" style="width:100%; background:#636e72" onclick="saveCloudSettings()">Salva Chiavi</button>
            <button class="danger" style="width:100%; margin-top:10px; font-size:11px" onclick="resetCloud()">Reset</button>
        </div>`;
}

window.saveCloudSettings = () => {
    db.cloud.token = document.getElementById("clToken").value.trim();
    db.cloud.gistId = document.getElementById("clId").value.trim();
    save(); alert("Chiavi salvate!"); render();
}
window.resetCloud = () => { if(confirm("Resettare?")) { db.cloud={token:"",gistId:""}; save(); showCloudMenu(); } }

/* ================= RENDER & CORE ================= */
function render(){
  const u = db.users.find(u => u.id === db.currentUser);
  if(u) document.documentElement.style.setProperty("--main", u.color);
  document.getElementById("menu").innerHTML = "";
  if(!db.currentUser){ home(); return; }
  
  [["Database",searchDB],["Edicola",edicolaTab],["Aggiungi",addVolumes],["Cloud",showCloudMenu]].forEach(([t,f])=>{
    const b = document.createElement("button"); b.textContent = t; b.onclick = () => f(app); 
    document.getElementById("menu").appendChild(b);
  });
  searchDB(app);
}

function home(){
  app.innerHTML = "<h3 style='text-align:center;margin-top:50px'>Chi sei?</h3><div id='userList' style='display:flex; justify-content:center; gap:10px'></div>";
  db.users.forEach(u=>{
    const b = document.createElement("button"); b.textContent = u.name; b.style.background = u.color; b.className = "ok"; b.style.padding = "20px";
    b.onclick = () => { db.currentUser = u.id; save(); render(); };
    document.getElementById('userList').appendChild(b);
  });
}

function edicolaTab(c){
    const gid = db.users.find(u=>u.id===db.currentUser).groupId;
    c.innerHTML = `<h2 class="section-title">Edicola</h2><div id="edL"></div>`;
    let h = "";
    db.series.filter(s=>s.groupId===gid).forEach(sr=>{
        const vols = db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===gid).map(v=>v.number);
        const max = vols.length ? Math.max(...vols) : 0;
        let gaps = []; for(let i=1;i<max;i++) if(!vols.includes(i)) gaps.push(i);
        if(gaps.length || max >= 0){
            h += `<div class="card"><b>${sr.name}</b><br>Mancanti: ${gaps.join(', ') || 'Nessuno'}<br>Prossimo: ${max+1}</div>`;
        }
    });
    document.getElementById("edL").innerHTML = h || "Tutto aggiornato!";
}

function searchDB(c){
    const gid = db.users.find(u=>u.id===db.currentUser).groupId;
    c.innerHTML = `<h2 class="section-title">Catalogo</h2><div id="res"></div>`;
    document.getElementById("res").innerHTML = db.series.filter(s=>s.groupId===gid).map(sr=>{
        const v = db.volumes.filter(vol=>vol.seriesId===sr.id && vol.groupId===gid).map(vol=>vol.number).sort((a,b)=>a-b);
        return `<div class="card"><b>${sr.name}</b><br><small>${v.join(', ')}</small></div>`;
    }).join('');
}

function addVolumes(c){
    const gid = db.users.find(u=>u.id===db.currentUser).groupId;
    c.innerHTML = `<h2 class="section-title">Gestione</h2>
    <div class="card"><h3>Nuova Serie</h3><input id="nsN" placeholder="Nome"><button class="ok" onclick="let n=document.getElementById('nsN').value; if(n){db.series.push({id:crypto.randomUUID(),name:n,groupId:'${gid}'});save();render();}">Crea</button></div>
    <div class="card"><h3>Aggiungi Volumi</h3><select id="vS">${db.series.filter(s=>s.groupId===gid).map(s=>`<option value="${s.id}">${s.name}</option>`)}</select><input type="number" id="vN" placeholder="Numero"><button class="ok" onclick="addV
