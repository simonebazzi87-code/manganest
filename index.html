<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest - Check Point</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:system-ui;background:#f5f6fa}
header{background:var(--main);color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap}
nav button{height:40px;border:none;border-radius:6px;padding:0 14px;cursor:pointer}
main{padding:12px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.cover{width:60px;height:80px;object-fit:cover;border-radius:4px;background:#ccc}
.cover-big{width:80px;height:110px;object-fit:cover;border-radius:6px;background:#ccc;box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
.small{font-size:12px;color:#555}
input,select{padding:6px;margin:4px 0;width:100%}
.ok{background:var(--main);color:#fff}
.danger{background:#e74c3c;color:#fff}
.volumeBtn{margin:2px;padding:6px 10px;border-radius:6px;border:none;background:#eee;font-weight:bold}
.recap-container{margin-top:15px;padding-top:15px;border-top:1px solid #eee;display:flex;gap:15px;align-items:flex-start}
</style>
</head>

<body>
<header>
  <h2>MangaNest</h2>
  <div>
    <span id="who"></span>
    <button id="switchUser" style="display:none">Cambia utente</button>
  </div>
</header>

<nav id="menu"></nav>
<main id="app"></main>

<script>
/* ================= DATABASE ================= */
let db = JSON.parse(localStorage.getItem("manganest")) || {
  users:[],
  currentUser:null,
  sagas:[],
  series:[],
  volumes:[]
};
const save=()=>localStorage.setItem("manganest",JSON.stringify(db));

const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

switchBtn.onclick=()=>{db.currentUser=null;render()};

/* ================= RENDER ================= */
function render(){
  const u=db.users.find(u=>u.id===db.currentUser);
  document.documentElement.style.setProperty("--main",u?.color||"#6c5ce7");
  who.textContent=u?`Utente: ${u.name}`:"";
  switchBtn.style.display=u?"inline":"none";

  menu.innerHTML="";
  if(!db.currentUser){home();return;}

  [
    ["Aggiungi serie",database], // Rinomata da Database
    ["Aggiungi numeri",addVolumes],
    ["Utenti",users]
  ].forEach(([t,f])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.onclick=()=>f(app);
    menu.appendChild(b);
  });

  database(app);
}

/* ================= HOME ================= */
function home(){
  app.innerHTML="<h3>Benvenuti! Scegliete chi siete:</h3>";
  db.users.forEach(u=>{
    const b=document.createElement("button");
    b.textContent=u.name;
    b.style.background=u.color;
    b.style.color="#fff";
    b.style.margin="5px";
    b.style.padding="10px 20px";
    b.style.borderRadius="8px";
    b.style.border="none";
    b.onclick=()=>{db.currentUser=u.id;save();render()};
    app.appendChild(b);
  });
}

/* ================= UTENTI ================= */
function users(c){
  c.innerHTML="<h2>Gestione Utenti</h2>";
  db.users.forEach(u=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <input value="${u.name}">
      <input type="color" value="${u.color}">
      <button class="ok">Aggiorna</button>
    `;
    d.querySelector(".ok").onclick=()=>{
      u.name=d.querySelector("input").value.trim();
      u.color=d.querySelector("input[type=color]").value;
      save();render();
    };
    c.appendChild(d);
  });

  const n=document.createElement("div");
  n.className="card";
  n.innerHTML=`<h3>Nuovo Utente</h3><input placeholder="Nome"><input type="color" value="#6c5ce7"><button class="ok">Aggiungi</button>`;
  n.querySelector("button").onclick=()=>{
    const name=n.querySelector("input").value.trim();
    if(!name)return;
    db.users.push({id:crypto.randomUUID(),name,color:n.querySelector("input[type=color]").value});
    save();render();
  };
  c.appendChild(n);
}

/* ================= AGGIUNGI SERIE (Ex Database) ================= */
function database(c){
  c.innerHTML="<h2>Aggiungi serie</h2>";

  const ns=document.createElement("div");
  ns.className="card";
  ns.innerHTML=`<h3>1. Crea Saga (opzionale)</h3><input placeholder="Esempio: Dragon Ball"><button class="ok">Crea Saga</button>`;
  ns.querySelector("button").onclick=()=>{
    const v=ns.querySelector("input").value.trim();
    if(!v)return;
    db.sagas.push({id:crypto.randomUUID(),name:v});
    save();render();
  };
  c.appendChild(ns);

  const s=document.createElement("div");
  s.className="card";
  s.innerHTML=`
    <h3>2. Registra Nuova Serie</h3>
    <input placeholder="Titolo della serie">
    <select>
      <option value="">Saga: Stesso nome della serie</option>
      ${db.sagas.sort((a,b)=>a.name.localeCompare(b.name)).map(x=>`<option value="${x.id}">${x.name}</option>`).join('')}
    </select>
    <select>
      <option>in corso</option>
      <option>finita</option>
      <option>interrotta</option>
    </select>
    <input placeholder="Autori (separati da virgola)">
    <input placeholder="Casa editrice">
    <input placeholder="URL immagine copertina">
    <button class="ok">Salva nel Database</button>
  `;
  s.querySelector("button").onclick=()=>{
    const inputs=s.querySelectorAll("input,select");
    const name=inputs[0].value.trim();
    if(!name)return;
    let sagaId=inputs[1].value;
    if(!sagaId){
      const sg={id:crypto.randomUUID(),name};
      db.sagas.push(sg);
      sagaId=sg.id;
    }
    db.series.push({
      id:crypto.randomUUID(),
      name,
      sagaId,
      status:inputs[2].value,
      authors:inputs[3].value.split(",").map(x=>x.trim()).filter(Boolean),
      publisher:inputs[4].value,
      img:inputs[5].value
    });
    save();render();
  };
  c.appendChild(s);
}

/* ================= AGGIUNGI NUMERI ================= */
function addVolumes(c){
  c.innerHTML="<h2>Aggiungi numeri</h2>";
  if(!db.series.length){
    c.innerHTML+="<p>Nessuna serie nel database. Aggiungine una prima!</p>";
    return;
  }

  const s=document.createElement("div");
  s.className="card";
  s.innerHTML=`
    <label>Seleziona Serie:</label>
    <select id="selSerieAdd"></select>
    <input type="number" placeholder="Dal numero">
    <input type="number" placeholder="Al numero (se uguale a 'Dal', lascia vuoto)">
    <button class="ok" style="margin-top:10px">Aggiungi volumi</button>
    <div id="recapDisplay" class="recap-container" style="display:none"></div>
  `;
  
  const sel=s.querySelector("#selSerieAdd");
  db.series.sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(x=>sel.innerHTML+=`<option value="${x.id}">${x.name}</option>`);

  s.querySelector("button").onclick=()=>{
    const start=Number(s.querySelectorAll("input")[0].value);
    const end=Number(s.querySelectorAll("input")[1].value)||start;
    const seriesId=sel.value;
    const seriesObj = db.series.find(x => x.id === seriesId);
    const recap = s.querySelector("#recapDisplay");
    
    recap.style.display = "flex";
    
    // Generiamo i bottoni dei numeri aggiunti
    let buttonsHtml = "";
    for(let i=start; i<=end; i++){
      if(!db.volumes.find(v=>v.seriesId===seriesId && v.number===i && v.userId === db.currentUser)){
        db.volumes.push({id:crypto.randomUUID(), seriesId, number:i, userId: db.currentUser});
        buttonsHtml += `<button class="volumeBtn">${i}</button>`;
      }
    }
    
    // Mostriamo FOTO, TITOLO, AUTORE, EDITORE + Numeri (MODIFICA RICHIESTA)
    recap.innerHTML = `
      <img class="cover-big" src="${seriesObj.img || 'https://via.placeholder.com/80x110'}">
      <div>
        <div style="font-weight:bold; font-size:16px">${seriesObj.name}</div>
        <div class="small">di ${seriesObj.authors.join(", ")}</div>
        <div class="small" style="color:var(--main); font-weight:bold">${seriesObj.publisher}</div>
        <div style="margin-top:8px">
          <span class="small">Numeri aggiunti:</span><br>
          ${buttonsHtml || '<span class="small">Gi√† presenti</span>'}
        </div>
      </div>
    `;
    save();
  };

  c.appendChild(s);
}

render();
</script>
</body>
</html>
