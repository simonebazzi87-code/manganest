<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;--bg:#f5f6fa;}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
header{background:var(--main);color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;}
nav button{height:42px;border:none;border-radius:6px;padding:0 16px;cursor:pointer;}
main{padding:12px;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;}
.row{display:flex;gap:10px;align-items:center;margin:6px 0;}
.cover{width:50px;height:70px;object-fit:cover;border-radius:4px;background:#ccc;}
.volumes{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.volume{padding:6px 10px;border-radius:6px;background:#eee;}
.ok{background:var(--main);color:#fff;}
select,input{width:100%;padding:6px;margin:6px 0;}
</style>
</head>
<body>

<header>
  <div>
    <h1 style="margin:0">MangaNest</h1>
    <div id="who"></div>
  </div>
  <button id="switchUser" style="display:none">Cambia utente</button>
</header>

<nav id="menu"></nav>
<main id="app"></main>

<script>
let db = JSON.parse(localStorage.getItem("manganest")) || {
  users: [
    {id:"simone",name:"Simone",color:"#6c5ce7"},
    {id:"andrea",name:"Andrea",color:"#e84393"}
  ],
  currentUser:null,
  sagas:[],
  series:[],
  volumes:[]
};

function save(){ localStorage.setItem("manganest",JSON.stringify(db)); }

const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

switchBtn.onclick=()=>{ db.currentUser=null; render(); };

function render(){
  const user=db.users.find(u=>u.id===db.currentUser);
  document.documentElement.style.setProperty("--main", user?.color || "#6c5ce7");
  who.textContent=user ? "Utente: "+user.name : "";
  switchBtn.style.display=user?"inline-block":"none";

  menu.innerHTML="";
  if(!db.currentUser){ home(); return; }

  [
    ["Database",database],
    ["Aggiungi numeri",addVolumes],
    ["Utenti",users],
    ["Lettura",reading]
  ].forEach(([t,f])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.onclick=()=>f(app);
    menu.appendChild(b);
  });

  database(app);
}

function home(){
  app.innerHTML="<h2>Scegli utente</h2>";
  db.users
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(u=>{
      const b=document.createElement("button");
      b.textContent=u.name;
      b.style.background=u.color;
      b.style.color="#fff";
      b.style.margin="6px";
      b.onclick=()=>{ db.currentUser=u.id; save(); render(); };
      app.appendChild(b);
    });
}

/* ------------------ UTENTI ------------------ */
function users(c){
  c.innerHTML="<h2>Utenti</h2>";
  db.users
    .slice()
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(u=>{
      const d=document.createElement("div");
      d.className="card";
      d.innerHTML=`
        <input value="${u.name}">
        <input type="color" value="${u.color}">
        <button class="ok">Salva</button>
      `;
      d.querySelector(".ok").onclick=()=>{
        u.name=d.querySelector("input").value.trim();
        u.color=d.querySelector("input[type=color]").value;
        save(); render();
      };
      c.appendChild(d);
    });
}

/* ------------------ DATABASE ------------------ */
function database(c){
  c.innerHTML="<h2>Database</h2>";

  const sagaBox=document.createElement("div");
  sagaBox.className="card";
  sagaBox.innerHTML=`
    <h3>Nuova saga</h3>
    <input id="newSaga">
    <button class="ok">Aggiungi</button>
  `;
  sagaBox.querySelector("button").onclick=()=>{
    const n=sagaBox.querySelector("input").value.trim();
    if(n && !db.sagas.find(s=>s.name===n)){
      db.sagas.push({id:crypto.randomUUID(),name:n});
      save(); render();
    }
  };
  c.appendChild(sagaBox);

  const seriesBox=document.createElement("div");
  seriesBox.className="card";
  seriesBox.innerHTML=`
    <h3>Nuova serie</h3>
    <input id="sn" placeholder="Nome serie">
    <select id="ss">
      <option value="">Nessuna saga</option>
      ${db.sagas.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<option value="${s.id}">${s.name}</option>`)}
    </select>
    <button class="ok">Aggiungi</button>
  `;
  seriesBox.querySelector("button").onclick=()=>{
    const name=seriesBox.querySelector("#sn").value.trim();
    if(!name) return;
    let sagaId=seriesBox.querySelector("#ss").value;
    if(!sagaId){
      const sg={id:crypto.randomUUID(),name};
      db.sagas.push(sg);
      sagaId=sg.id;
    }
    db.series.push({id:crypto.randomUUID(),name,sagaId});
    save(); render();
  };
  c.appendChild(seriesBox);
}

/* ------------------ AGGIUNGI VOLUMI ------------------ */
function addVolumes(c){
  c.innerHTML="<h2>Aggiungi numeri</h2>";
  if(!db.series.length){ c.innerHTML+="<p>Nessuna serie</p>"; return; }

  const box=document.createElement("div");
  box.className="card";
  box.innerHTML=`
    <select id="s">
      ${db.series.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<option value="${s.id}">${s.name}</option>`)}
    </select>
    <input id="from" type="number" placeholder="Dal numero">
    <input id="to" type="number" placeholder="Al numero">
    <button class="ok">Aggiungi</button>
  `;
  box.querySelector("button").onclick=()=>{
    const sid=box.querySelector("#s").value;
    let a=+box.querySelector("#from").value;
    let b=+box.querySelector("#to").value || a;
    for(let i=a;i<=b;i++){
      if(!db.volumes.find(v=>v.series===sid && v.number===i))
        db.volumes.push({series:sid,number:i});
    }
    save(); alert("Volumi aggiunti");
  };
  c.appendChild(box);
}

/* ------------------ LETTURA (STEP 1) ------------------ */
function reading(c){
  c.innerHTML="<h2>Lettura</h2>";

  const box=document.createElement("div");
  box.className="card";
  box.innerHTML=`
    <label>Saga (opzionale)</label>
    <select id="sagaSel">
      <option value="">-- Tutte le saghe --</option>
      ${db.sagas.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<option value="${s.id}">${s.name}</option>`)}
    </select>

    <label>Serie</label>
    <select id="seriesSel">
      <option value="">-- Seleziona serie --</option>
    </select>

    <div id="result"></div>
  `;
  c.appendChild(box);

  const sagaSel=box.querySelector("#sagaSel");
  const seriesSel=box.querySelector("#seriesSel");
  const result=box.querySelector("#result");

  function refreshSeries(){
    const sid=sagaSel.value;
    let list=db.series;
    if(sid) list=list.filter(s=>s.sagaId===sid);
    seriesSel.innerHTML="<option value=''>-- Seleziona serie --</option>"+
      list.slice().sort((a,b)=>a.name.localeCompare(b.name))
        .map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
    result.innerHTML="";
  }

  function showVolumes(){
    result.innerHTML="";
    const sid=seriesSel.value;
    if(!sid) return;
    const vols=db.volumes
      .filter(v=>v.series===sid)
      .sort((a,b)=>a.number-b.number);
    const div=document.createElement("div");
    div.className="volumes";
    vols.forEach(v=>{
      const b=document.createElement("div");
      b.className="volume";
      b.textContent=v.number;
      div.appendChild(b);
    });
    result.appendChild(div);
  }

  sagaSel.onchange=refreshSeries;
  seriesSel.onchange=showVolumes;

  refreshSeries();
}

render();
</script>
</body>
</html>
