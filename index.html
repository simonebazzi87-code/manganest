<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest Ultimate - Simone & Andrea</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:system-ui;background:#f5f6fa}
header{background:var(--main);color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;border-bottom:1px solid #ddd}
nav button{height:40px;border:none;border-radius:6px;padding:0 14px;cursor:pointer;background:#eee;font-weight:bold}
nav button.active{background:var(--main);color:#fff}
main{padding:12px; padding-bottom:100px}

.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:12px;border:1px solid #eee;box-shadow: 0 2px 4px rgba(0,0,0,0.05)}

/* FIX LAYOUT FOTO & ALLINEAMENTO (Punto 2) */
.row-edit { display: flex; gap: 15px; align-items: flex-start; padding: 10px; flex-wrap: nowrap; }
.col-cover { flex: 0 0 120px; } 
.col-info { flex: 1; min-width: 0; } 

.vol-container { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    margin: 5px; 
    min-width: 45px; /* Forza l'allineamento in colonna */
}
.volumeStatic{padding:5px 8px; border-radius:6px; border:1.5px solid #eee; background:#fff; font-size:14px; font-weight:bold; width: 100%; text-align: center; box-sizing: border-box;}
.volumeBtn{padding:8px; border-radius:6px; border:1px solid #ddd; background:#f9f9f9; cursor:pointer; font-weight:bold; width: 100%;}

.cover-big{width:120px; height:180px; object-fit:cover; border-radius:8px; background:#ccc; border:1px solid #ddd;}
input,select{padding:10px;margin:5px 0;width:100%;border:1px solid #ccc;border-radius:6px; box-sizing: border-box;}
.ok{background:var(--main);color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold}
.danger{background:#e74c3c;color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold}

.read-indicators { display: flex; gap: 3px; height: 8px; margin-top: 4px; justify-content: center; min-height:8px; }
.dot { width: 8px; height: 8px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

.section-title{border-left: 4px solid var(--main); padding-left: 10px; margin: 20px 0 10px 0; color: #2d3436}
.buy-tag{background:#27ae60; color:white; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:bold}
.small{font-size:12px; color:#666}
</style>
</head>

<body>
<header>
  <h2>MangaNest <span id="groupLabel" style="font-size:12px; opacity:0.8"></span></h2>
  <div><span id="who"></span> <button id="switchUser" style="display:none;font-size:10px;margin-left:10px">Esci</button></div>
</header>
<nav id="menu"></nav>
<main id="app"></main>

<script>
/* ================= DATABASE ================= */
let db = JSON.parse(localStorage.getItem("manganest_v5")) || {
  users: [{id: "u1", name: "Simone", color: "#0984e3", groupId: "default"}, {id: "u2", name: "Andrea", color: "#e84393", groupId: "default"}],
  groups: [{id: "default", name: "Casa"}],
  publishers: ["Panini Comics", "Star Comics", "J-Pop", "Planet Manga"], 
  currentUser: null, sagas: [], series: [], volumes: [], read: []
};

const save=()=>localStorage.setItem("manganest_v5",JSON.stringify(db));
const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

switchBtn.onclick=()=>{db.currentUser=null; save(); render();};
function getActiveGroup() { const u = db.users.find(u => u.id === db.currentUser); return u ? u.groupId : "default"; }

function render(){
  const u = db.users.find(u => u.id === db.currentUser);
  if(u) document.documentElement.style.setProperty("--main", u.color);
  who.textContent = u ? `Utente: ${u.name}` : "";
  const group = db.groups.find(g => g.id === (u?.groupId || "default"));
  document.getElementById("groupLabel").textContent = u ? `[Gruppo: ${group.name}]` : "";
  switchBtn.style.display = u ? "inline" : "none";
  menu.innerHTML = "";
  if(!db.currentUser){home(); return;}
  
  [["Database",searchDB],["Fumetteria",fumetteriaTab],["Segna come letto",readTab],["Aggiungi numeri",addVolumes],["Aggiungi serie",addSeries],["Utenti",users],["Backup",backupMenu]].forEach(([t,f])=>{
    const b = document.createElement("button"); b.textContent = t; b.onclick = () => f(app); menu.appendChild(b);
  });
  searchDB(app);
}

function home(){
  app.innerHTML = "<h3 style='text-align:center; margin-top:50px'>Chi sei?</h3><div id='userList' style='display:flex; justify-content:center; flex-wrap:wrap; gap:10px'></div>";
  db.users.forEach(u=>{
    const b = document.createElement("button"); b.textContent = u.name; b.style.background = u.color; b.className = "ok"; b.style.padding = "20px 30px";
    b.onclick = () => { db.currentUser = u.id; save(); render(); };
    document.getElementById('userList').appendChild(b);
  });
}

/* ================= DATABASE (Punto 1, 2, 7) ================= */
function searchDB(c){
  c.innerHTML=`<h2 class="section-title">Catalogo</h2>
    <div class="card"><input type="text" id="dbSearch" placeholder="Cerca Saga o Serie..." oninput="doSearch()"></div>
    <div id="searchRes"></div>`;
  doSearch();
}

window.doSearch=()=>{
  const query = document.getElementById("dbSearch") ? document.getElementById("dbSearch").value.toLowerCase() : "";
  const gid=getActiveGroup();
  const groupMembers = db.users.filter(u => u.groupId === gid);

  let fSagas = db.sagas.filter(s => s.groupId === gid && (
    s.name.toLowerCase().includes(query) || 
    db.series.some(sr => sr.sagaId === s.id && sr.name.toLowerCase().includes(query))
  )).sort((a,b)=>a.name.localeCompare(b.name));

  document.getElementById("searchRes").innerHTML=fSagas.map(sg=>{ 
      const sS=db.series.filter(r=>r.sagaId===sg.id).sort((a,b)=>a.name.localeCompare(b.name));
      return `<div class="card"><h3 style="color:var(--main); border-bottom:1px solid #eee">${sg.name}</h3>${sS.map(sr=>{ 
          const aV=db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===gid).sort((a,b)=>a.number-b.number); 
          return `<div class="row-edit">
            <div class="col-cover"><img src="${sr.img}" class="cover-big"></div>
            <div class="col-info">
              <b style="font-size:22px">${sr.name}</b><br>
              <span class="small">${sr.authors} | ${sr.publisher} (${sr.status})</span><br>
              <div style="display:flex; flex-wrap:wrap; margin-top:10px">
                ${aV.map(v=>{
                  const dots = groupMembers.map(m => db.read.some(r=>r.volId===v.id && r.userId===m.id) ? `<span class="dot" style="background:${m.color}"></span>` : '').join('');
                  return `<div class="vol-container"><span class="volumeStatic">${v.number}</span><div class="read-indicators">${dots}</div></div>`;
                }).join('')}
              </div>
            </div>
          </div>`; 
      }).join('')}</div>`; 
  }).join('');
}

/* ================= FUMETTERIA (Punti 5, 6, 7) ================= */
function fumetteriaTab(c){
  c.innerHTML = `<h2 class="section-title">Fumetteria</h2>
    <div class="card"><input type="text" id="fSearch" placeholder="Cerca serie o saga..." oninput="renderFumetteria()"></div>
    <div id="fList"></div>`;
  renderFumetteria();
}

window.renderFumetteria = () => {
    const query = document.getElementById("fSearch").value.toLowerCase();
    const gid = getActiveGroup();
    let series = db.series.filter(s => s.groupId === gid && s.name.toLowerCase().includes(query));
    
    let h = "";
    series.forEach(sr => {
        const vols = db.volumes.filter(v => v.seriesId === sr.id && v.groupId === gid).map(v=>v.number);
        const max = vols.length > 0 ? Math.max(...vols) : 0;
        let gaps = []; for(let i=1; i<max; i++) if(!vols.includes(i)) gaps.push(i);
        let next = (sr.status === "In Corso" || max === 0) ? max + 1 : null;

        if(gaps.length > 0 || next) {
            h += `<div class="card"><div class="row-edit">
                <div class="col-cover"><img src="${sr.img}" class="cover-big"></div>
                <div class="col-info">
                    <div style="display:flex; justify-content:space-between"><b>${sr.name}</b> <span class="buy-tag">DA PRENDERE</span></div>
                    <div style="display:flex; flex-wrap:wrap; margin-top:10px">
                        ${gaps.map(n => `<div class="vol-container"><span class="volumeStatic" style="border-color:#e74c3c; color:#e74c3c">${n}</span><span class="small">Mancante</span></div>`).join('')}
                        ${next ? `<div class="vol-container"><span class="volumeStatic" style="border-color:#27ae60; color:#333">${next}</span><span class="small">Nuovo</span></div>` : ''}
                    </div>
                </div>
            </div></div>`;
        }
    });
    document.getElementById("fList").innerHTML = h || `<div class="card">Tutto in regola! Nessun volume da acquistare.</div>`;
}

/* ================= SEGNA COME LETTO ================= */
function readTab(c){
  c.innerHTML=`<h2 class="section-title">Segna come letto</h2>
    <div class="card"><input type="text" id="readSearch" placeholder="Cerca serie..." oninput="renderReadList()"></div>
    <div id="readArea"></div>`;
  renderReadList();
}
window.renderReadList=()=>{
  const query = (document.getElementById("readSearch")?.value || "").toLowerCase();
  const gid=getActiveGroup(); const user=db.users.find(u=>u.id===db.currentUser);
  const groupMembers = db.users.filter(u => u.groupId === user.groupId);
  
  document.getElementById("readArea").innerHTML=db.series.filter(s=>s.groupId===gid && s.name.toLowerCase().includes(query)).map(sr=>{
    const myGroupVols=db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===user.groupId).sort((a,b)=>a.number-b.number);
    if(myGroupVols.length===0) return "";
    return `<div class="card"><div class="row-edit">
      <div class="col-cover"><img src="${sr.img}" class="cover-big"></div>
      <div class="col-info">
        <h3>${sr.name}</h3>
        <div style="display:flex;flex-wrap:wrap">${myGroupVols.map(v=>{
            const dots = groupMembers.map(m => db.read.some(r=>r.volId===v.id && r.userId===m.id) ? `<span class="dot" style="background:${m.color}"></span>` : '').join('');
            const amIRead=db.read.some(r=>r.volId===v.id && r.userId===user.id);
            return `<div class="vol-container"><button class="volumeBtn" style="${amIRead?`background:${user.color};color:white;border:none`:''}" onclick="toggleRead('${v.id}')">${v.number}</button><div class="read-indicators">${dots}</div></div>`;
        }).join('')}</div>
      </div>
    </div></div>`;
  }).join('');
}
window.toggleRead=(volId)=>{ const idx=db.read.findIndex(r=>r.volId===volId && r.userId===db.currentUser); if(idx>-1) db.read.splice(idx,1); else db.read.push({volId, userId:db.currentUser}); save(); renderReadList(); }

/* ================= AGGIUNGI SERIE (Punto 14) ================= */
function addSeries(c){
  const gid = getActiveGroup();
  const sortedSagas = db.sagas.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name));
  
  c.innerHTML = `<h2 class="section-title">Aggiungi Serie</h2>
    <div class="card"><h3>1. Crea Casa Editrice</h3>
      <div style="display:flex; gap:10px"><input id="newPubName" placeholder="Es: Panini, J-Pop..."><button class="ok" onclick="addPub()">Aggiungi</button></div>
    </div>
    <div class="card"><h3>2. Crea Saga</h3>
      <div style="display:flex; gap:10px"><input id="sagaNameOnly" placeholder="Nome Saga"><button class="ok" onclick="createSagaOnly()">Crea</button></div>
    </div>
    <div class="card"><h3>3. Nuova Serie</h3>
      <input id="nsTitolo" placeholder="Titolo">
      <select id="nsSagaSelect"><option value="NEW">Crea nuova Saga</option>${sortedSagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
      <input id="nsAutore" placeholder="Autore">
      <select id="nsEditore">${db.publishers.sort().map(p=>`<option value="${p}">${p}</option>`).join('')}</select>
      <input id="nsImg" placeholder="URL Immagine">
      <select id="nsStatus"><option value="In Corso">In Corso</option><option value="Terminata">Terminata</option></select>
      <button class="ok" style="width:100%; margin-top:10px" onclick="createSerieFull()">Salva Serie</button>
    </div>
    <h2 class="section-title">Modifica Esistenti</h2>
    <div class="card"><input type="text" id="editSearch" placeholder="Cerca serie da modificare..." oninput="renderEditArea()"></div>
    <div id="editArea"></div>`;
}

window.addPub=()=>{
  const n = document.getElementById("newPubName").value.trim();
  if(n && !db.publishers.includes(n)) { db.publishers.push(n); save(); addSeries(app); }
}

window.createSerieFull=()=>{
  const name=document.getElementById("nsTitolo").value.trim(); if(!name)return;
  let sagaId=document.getElementById("nsSagaSelect").value; const gid=getActiveGroup();
  if(sagaId==="NEW"){ const ns={id:crypto.randomUUID(), name, groupId:gid}; db.sagas.push(ns); sagaId=ns.id; }
  db.series.push({id:crypto.randomUUID(), name, sagaId, groupId:gid, authors:document.getElementById("nsAutore").value, publisher:document.getElementById("nsEditore").value, img:document.getElementById("nsImg").value, status:document.getElementById("nsStatus").value});
  save(); addSeries(app);
}

window.renderEditArea=()=>{
    const query = document.getElementById("editSearch").value.toLowerCase();
    if(!query) { document.getElementById("editArea").innerHTML=""; return; }
    const gid=getActiveGroup();
    const series = db.series.filter(s=>s.groupId===gid && s.name.toLowerCase().includes(query));
    document.getElementById("editArea").innerHTML=series.map(sr=>`
        <div class="card"><div class="row-edit">
            <div class="col-cover"><img src="${sr.img}" class="cover-big"></div>
            <div class="col-info">
                <input id="t-${sr.id}" value="${sr.name}">
                <select id="e-${sr.id}">${db.publishers.map(p=>`<option value="${p}" ${sr.publisher===p?'selected':''}>${p}</option>`).join('')}</select>
                <div style="margin-top:10px"><button class="ok" onclick="updateFullSerie('${sr.id}')">Salva</button> <button class="danger" onclick="deleteSerie('${sr.id}')">Elimina</button></div>
            </div>
        </div></div>`).join('');
}

window.updateFullSerie=(id)=>{ 
  const s=db.series.find(x=>x.id===id); 
  s.name=document.getElementById(`t-${id}`).value; 
  s.publisher=document.getElementById(`e-${id}`).value; 
  save(); renderEditArea(); 
}
window.deleteSerie=(id)=>{ if(confirm("Eliminare?")){ db.series=db.series.filter(s=>s.id!==id); db.volumes=db.volumes.filter(v=>v.seriesId!==id); save(); renderEditArea(); }}
window.createSagaOnly=()=>{ const n=document.getElementById("sagaNameOnly").value.trim(); if(!n)return; db.sagas.push({id:crypto.randomUUID(), name:n, groupId:getActiveGroup()}); save(); addSeries(app); }

/* ================= AGGIUNGI NUMERI ================= */
function addVolumes(c){
  const gid = getActiveGroup(); 
  c.innerHTML=`<h2 class="section-title">Aggiungi Numeri</h2>
    <div class="card"><input type="text" id="vSearch" placeholder="Cerca serie..." oninput="filterVSerie()">
    <select id="vSerie" onchange="showUserVols()"></select>
    <div id="seriePreview" style="margin-top:15px"></div>
    <div id="vInputArea" style="display:none">
      <div style="display:flex; gap:10px"><input type="number" id="vStart" placeholder="Da"><input type="number" id="vEnd" placeholder="A"></div>
      <button class="ok" style="width:100%; margin-top:10px" onclick="saveVols()">Aggiungi</button>
      <div id="errorArea" class="error-msg"></div>
    </div></div><div id="vList"></div>`;
  filterVSerie();
}
window.filterVSerie=()=>{
  const q = document.getElementById("vSearch").value.toLowerCase();
  const series = db.series.filter(s => s.groupId === getActiveGroup() && s.name.toLowerCase().includes(q));
  document.getElementById("vSerie").innerHTML = `<option value="">-- Seleziona --</option>` + series.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function showUserVols(){
  const sid=document.getElementById("vSerie").value; if(!sid) return;
  const sr=db.series.find(x=>x.id===sid); document.getElementById("vInputArea").style.display="block";
  document.getElementById("seriePreview").innerHTML=`<div class="row-edit"><div class="col-cover"><img src="${sr.img}" class="cover-big"></div><div class="col-info"><h3>${sr.name}</h3></div></div>`;
  const groupVols=db.volumes.filter(v=>v.seriesId===sid && v.groupId===getActiveGroup()).sort((a,b)=>a.number-b.number);
  document.getElementById("vList").innerHTML=`<div class="card"><h4>Posseduti:</h4><div style="display:flex;flex-wrap:wrap">${groupVols.map(v=>`<button class="volumeBtn" onclick="removeVol('${v.id}')">${v.number}</button>`).join('')}</div></div>`;
}
window.saveVols=()=>{
  const sid=document.getElementById("vSerie").value, start=Number(document.getElementById("vStart").value), end=Number(document.getElementById("vEnd").value)||start, gid=getActiveGroup();
  for(let i=start; i<=end; i++) if(!db.volumes.find(v=>v.seriesId===sid && v.number===i && v.groupId===gid)) db.volumes.push({id:crypto.randomUUID(), seriesId:sid, number:i, groupId:gid});
  save(); showUserVols();
}
window.removeVol=(id)=>{ if(confirm("Eliminare?")){db.volumes=db.volumes.filter(v=>v.id!==id); save(); showUserVols();}}

/* ================= UTENTI & GRUPPI (Punto 3) ================= */
function users(c){
  c.innerHTML = `<h2 class="section-title">Gestione Gruppi</h2>
    <div class="card"><div style="display:flex; gap:10px"><input id="newGN" placeholder="Nome nuovo gruppo"><button class="ok" onclick="addG()">Crea</button></div></div>
    <div id="gList"></div>
    <h2 class="section-title">Profili</h2>
    <div id="uList"></div>
    <div class="card"><h3>Nuovo Profilo</h3><input id="newUN" placeholder="Nome"><button class="ok" onclick="addU()">Crea</button></div>`;
  
  document.getElementById("gList").innerHTML = db.groups.map(g=>`<div class="card" style="display:flex; justify-content:space-between"><span>${g.name}</span>${g.id!=='default'?`<button class="danger" onclick="delG('${g.id}')">X</button>`:''}</div>`).join('');
  document.getElementById("uList").innerHTML = db.users.map(u=>`<div class="card">
    <input id="un-${u.id}" value="${u.name}">
    <select id="ug-${u.id}">${db.groups.map(g=>`<option value="${g.id}" ${u.groupId===g.id?'selected':''}>${g.name}</option>`).join('')}</select>
    <div style="margin-top:10px"><button class="ok" onclick="upU('${u.id}')">Salva</button> <button class="danger" onclick="delU('${u.id}')">Elimina</button></div>
  </div>`).join('');
}
window.addG=()=>{ const n=document.getElementById("newGN").value; if(n){db.groups.push({id:crypto.randomUUID(), name:n}); save(); users(app);}}
window.delG=(id)=>{ if(confirm("Eliminare gruppo?")){db.groups=db.groups.filter(g=>g.id!==id); save(); users(app);}}
window.addU=()=>{ const n=document.getElementById("newUN").value; if(n){db.users.push({id:crypto.randomUUID(), name:n, color:"#6c5ce7", groupId:"default"}); save(); users(app);}}
window.delU=(id)=>{ if(confirm("Eliminare utente?")){db.users=db.users.filter(u=>u.id!==id); save(); render();}}
window.upU=(id)=>{ const u=db.users.find(x=>x.id===id); u.name=document.getElementById(`un-${id}`).value; u.groupId=document.getElementById(`ug-${id}`).value; save(); render(); }

/* ================= BACKUP ================= */
function backupMenu(c){
    c.innerHTML = `<h2 class="section-title">Backup</h2><div class="card"><button class="ok" style="width:100%" onclick="exportDB()">Scarica Backup .json</button></div>`;
}
window.exportDB = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
    const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "manganest_backup.json");
    dl.click();
}

render();
</script>
</body>
</html>
