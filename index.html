<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest - Cloud Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;}
body{margin:0;font-family:system-ui;background:#f5f6fa}
header{background:var(--main);color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;border-bottom:1px solid #ddd}
nav button{height:40px;border:none;border-radius:6px;padding:0 14px;cursor:pointer;background:#eee}
nav button.active{background:var(--main);color:#fff}
main{padding:12px}
.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:12px;border:1px solid #eee;box-shadow: 0 2px 4px rgba(0,0,0,0.05)}
.row-edit{display:flex;gap:15px;align-items:flex-start;padding:10px;border-bottom:1px solid #eee; flex-wrap: wrap;}
.cover-big{width:100px; height:150px; object-fit:cover; border-radius:8px; background:#ccc; border:1px solid #ddd;}
input,select{padding:10px;margin:5px 0;width:100%;border:1px solid #ccc;border-radius:6px; box-sizing: border-box;}
.ok{background:var(--main);color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold}
.danger{background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
.vol-container { display: flex; flex-direction: column; align-items: center; margin: 4px; }
.volumeBtn{margin:0; padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:bold; min-width:45px}
.volumeStatic{padding:5px 12px;border-radius:6px;border:1.5px solid #eee;background:#fff;display:inline-block;font-size:14px;font-weight:bold;text-align:center}
.m-label{font-size:10px; font-weight:bold; margin-top:2px; text-transform:uppercase}
.read-indicators { display: flex; gap: 3px; height: 8px; margin-top: 4px; justify-content: center; min-height:8px; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }
.section-title{border-left: 4px solid var(--main); padding-left: 10px; margin: 20px 0 10px 0; color: #2d3436}
.buy-tag{background:#27ae60; color:white; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:bold; height:fit-content}
.small{font-size:12px; color:#666}
.filter-bar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; background:#fff; padding:10px; border-radius:8px; border:1px solid #eee}
.filter-bar button{padding:8px 15px; border-radius:6px; border:1px solid #ddd; background:#f9f9f9; cursor:pointer; font-weight:500}
.filter-bar button.active{background:var(--main); color:#fff; border-color:var(--main)}
.filter-bar select{width:auto; min-width:140px; margin:0; height:36px; padding:0 10px; font-size:13px}
</style>
</head>

<body>
<header>
  <h2>MangaNest <span id="groupLabel" style="font-size:12px; opacity:0.8"></span></h2>
  <div><span id="who"></span> <button id="switchUser" style="display:none;font-size:10px;margin-left:10px">Esci</button></div>
</header>
<nav id="menu"></nav>
<main id="app"></main>

<script>
/* ================= DATABASE & STATE ================= */
let db = JSON.parse(localStorage.getItem("manganest_v5")) || {
  users: [
    {id: "u1", name: "Simone", color: "#0984e3", groupId: "default"},
    {id: "u2", name: "Andrea", color: "#e84393", groupId: "default"}
  ],
  groups: [{id: "default", name: "Casa"}],
  currentUser: null,
  sagas: [], series: [], volumes: [], read: [],
  cloud: { token: "", gistId: "" }
};

let edMode = "ALL";
let edSagaFilter = ""; 
let edSerieFilter = "";

const save = () => localStorage.setItem("manganest_v5", JSON.stringify(db));
const app = document.getElementById("app");
const menu = document.getElementById("menu");
const who = document.getElementById("who");
const switchBtn = document.getElementById("switchUser");

switchBtn.onclick = () => { db.currentUser = null; save(); render(); };

function getActiveGroup() {
    const u = db.users.find(u => u.id === db.currentUser);
    return u ? u.groupId : "default";
}

/* ================= CLOUD LOGIC ================= */
async function syncCloud(mode) {
    if (!db.cloud.token || !db.cloud.gistId) {
        alert("Configura prima il Token e il Gist ID nelle impostazioni Cloud.");
        showCloudMenu();
        return;
    }
    const btn = document.getElementById("syncBtnMain");
    if(btn) { btn.disabled = true; btn.textContent = "⌛..."; }

    try {
        if (mode === 'UPLOAD') {
            const response = await fetch(`https://api.github.com/gists/${db.cloud.gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${db.cloud.token}` },
                body: JSON.stringify({ files: { "data.json": { content: JSON.stringify(db) } } })
            });
            if (response.ok) alert("✅ Dati inviati al Cloud!");
            else alert("❌ Errore durante l'invio.");
        } else {
            const response = await fetch(`https://api.github.com/gists/${db.cloud.gistId}`, {
                headers: { 'Authorization': `token ${db.cloud.token}` },
                cache: "no-store"
            });
            const data = await response.json();
            const remoteDb = JSON.parse(data.files["data.json"].content);
            if (confirm("Sovrascrivere i dati locali con quelli salvati online?")) {
                db = remoteDb;
                save();
                render();
                alert("✅ Dati scaricati e aggiornati!");
            }
        }
    } catch (e) {
        alert("❌ Errore di connessione. Controlla le chiavi.");
    } finally { if(btn) { btn.disabled = false; btn.textContent = "☁️ Cloud"; } }
}

/* ================= NAVIGATION ================= */
function render(){
  const u = db.users.find(u => u.id === db.currentUser);
  if(u) document.documentElement.style.setProperty("--main", u.color);
  who.textContent = u ? `Ciao, ${u.name}` : "";
  const group = db.groups.find(g => g.id === (u?.groupId || "default"));
  document.getElementById("groupLabel").textContent = u ? `[${group.name}]` : "";
  switchBtn.style.display = u ? "inline" : "none";
  menu.innerHTML = "";
  
  if(!db.currentUser){ home(); return; }
  
  [["Database",searchDB],["Edicola",edicolaTab],["Lettura",readTab],["Aggiungi",addVolumes],["Serie",addSeries],["Utenti",users]].forEach(([t,f])=>{
    const b = document.createElement("button");
    b.textContent = t; b.onclick = () => f(app); menu.appendChild(b);
  });

  const cloudBtn = document.createElement("button");
  cloudBtn.id = "syncBtnMain";
  cloudBtn.textContent = "☁️ Cloud";
  cloudBtn.style.background = "#2d3436";
  cloudBtn.style.color = "white";
  cloudBtn.onclick = () => showCloudMenu();
  menu.appendChild(cloudBtn);

  searchDB(app);
}

function home(){
  app.innerHTML = "<h3 style='text-align:center'>Seleziona Profilo</h3><div id='userList' style='display:flex; justify-content:center; flex-wrap:wrap; gap:10px'></div>";
  db.users.forEach(u=>{
    const b = document.createElement("button");
    b.textContent = u.name; b.style.background = u.color; b.className = "ok"; b.style.padding = "20px 30px";
    b.onclick = () => { db.currentUser = u.id; save(); render(); };
    document.getElementById('userList').appendChild(b);
  });
}

/* ================= TABS ================= */
function edicolaTab(c){
  const gid = getActiveGroup();
  const activeSeries = db.series.filter(sr => {
      if(sr.groupId !== gid) return false;
      const groupVols = db.volumes.filter(v => v.seriesId === sr.id && v.groupId === gid).map(v=>v.number);
      const max = groupVols.length > 0 ? Math.max(...groupVols) : 0;
      let hasGap = false;
      for(let i=1; i<max; i++) if(!groupVols.includes(i)) { hasGap = true; break; }
      return hasGap || (sr.status === "In Corso" || max === 0);
  }).sort((a,b)=>a.name.localeCompare(b.name));

  const activeSagaIds = [...new Set(activeSeries.map(s => s.sagaId))];
  const activeSagas = db.sagas.filter(sg => activeSagaIds.includes(sg.id)).sort((a,b)=>a.name.localeCompare(b.name));

  c.innerHTML = `
    <h2 class="section-title">Edicola</h2>
    <div class="filter-bar">
        <button class="${edMode==='ALL'?'active':''}" onclick="setEdMode('ALL')">Tutto</button>
        <button class="${edMode==='GAPS'?'active':''}" onclick="setEdMode('GAPS')">Solo Mancanti</button>
        <select onchange="setEdSaga(this.value)"><option value="">Filtra Saga...</option>${activeSagas.map(s => `<option value="${s.id}" ${edSagaFilter===s.id?'selected':''}>${s.name}</option>`).join('')}</select>
        <select onchange="setEdSerie(this.value)"><option value="">Filtra Serie...</option>${activeSeries.map(s => `<option value="${s.id}" ${edSerieFilter===s.id?'selected':''}>${s.name}</option>`).join('')}</select>
    </div>
    <div id="edicolaList"></div>`;
  renderEdicolaList();
}

window.setEdMode = (m) => { edMode = m; edicolaTab(app); }
window.setEdSaga = (id) => { edSagaFilter = id; edSerieFilter = ""; edicolaTab(app); }
window.setEdSerie = (id) => { edSerieFilter = id; edSagaFilter = ""; edicolaTab(app); }

window.renderEdicolaList = () => {
    const gid = getActiveGroup();
    const user = db.users.find(u => u.id === db.currentUser);
    let series = db.series.filter(s => s.groupId === gid);
    if(edSagaFilter) series = series.filter(s => s.sagaId === edSagaFilter);
    if(edSerieFilter) series = series.filter(s => s.id === edSerieFilter);
    series.sort((a,b)=>a.name.localeCompare(b.name));

    let h = "";
    series.forEach(sr => {
        const groupVols = db.volumes.filter(v => v.seriesId === sr.id && v.groupId === gid).map(v=>v.number).sort((a,b)=>a-b);
        let gaps = []; let next = null; const max = groupVols.length > 0 ? Math.max(...groupVols) : 0;
        for(let i=1; i<max; i++) if(!groupVols.includes(i)) gaps.push(i);
        if(edMode !== "GAPS" && (sr.status === "In Corso" || max === 0)) next = max + 1;

        if(gaps.length > 0 || next) {
            const saga = db.sagas.find(sg => sg.id === sr.sagaId);
            h += `<div class="card"><div class="row-edit" style="border:none;padding:0"><img src="${sr.img}" class="cover-big"><div style="flex:1">
                <div style="display:flex;justify-content:space-between"><b>${saga?saga.name+' - ':''}${sr.name}</b><span class="buy-tag">DA PRENDERE</span></div>
                <p class="small">${sr.publisher}</p><div style="display:flex;flex-wrap:wrap;margin-top:10px">
                ${gaps.map(n => `<div class="vol-container"><span class="volumeStatic" style="border-color:${user.color};color:${user.color}">${n}</span><span class="m-label" style="color:${user.color}">M</span></div>`).join('')}
                ${next ? `<div class="vol-container"><span class="volumeStatic" style="border-color:#27ae60;color:#333">${next}</span><span class="m-label" style="color:#27ae60">NEW</span></div>` : ''}
            </div></div></div></div>`;
        }
    });
    document.getElementById("edicolaList").innerHTML = h || `<div class="card">Tutto in ordine! Nessun volume mancante.</div>`;
}

function showCloudMenu() {
    app.innerHTML = `
        <h2 class="section-title">Cloud</h2>
        <div class="card">
            <button class="ok" style="width:100%; margin-bottom:10px" onclick="syncCloud('UPLOAD')">⬆️ Invia al Cloud</button>
            <button class="ok" style="width:100%; background:#00b894" onclick="syncCloud('DOWNLOAD')">⬇️ Scarica dal Cloud</button>
            <hr><p class="small">Impostazioni GitHub:</p>
            <input id="clToken" type="password" placeholder="GitHub Token" value="${db.cloud.token}">
            <input id="clId" placeholder="Gist ID" value="${db.cloud.gistId}">
            <button class="ok" style="width:100%;background:#636e72" onclick="saveCloudSettings()">Salva Chiavi</button>
            <button class="danger" style="width:100%;margin-top:10px" onclick="resetCloud()">Reset Chiavi</button>
        </div>`;
}

window.saveCloudSettings = () => {
    db.cloud.token = document.getElementById("clToken").value;
    db.cloud.gistId = document.getElementById("clId").value;
    save(); alert("Chiavi salvate!");
}
window.resetCloud = () => { if(confirm("Eliminare le chiavi?")) { db.cloud.token=""; db.cloud.gistId=""; save(); showCloudMenu(); } }

/* ================= ALTRE FUNZIONI (DB, LETTURA, AGGIUNGI) ================= */
function searchDB(c){
  const gid=getActiveGroup(); const sortedSagas = db.sagas.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name));
  c.innerHTML=`<h2 class="section-title">Catalogo</h2><div class="card"><select id="searchSaga" onchange="doSearch()"><option value="">Tutto (A-Z)</option>${sortedSagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select></div><div id="searchRes"></div>`;
  doSearch();
}
window.doSearch=()=>{
  const sid=document.getElementById("searchSaga").value; const gid=getActiveGroup();
  let fSagas=sid?db.sagas.filter(s=>s.id===sid):db.sagas.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name));
  document.getElementById("searchRes").innerHTML=fSagas.map(sg=>{ 
      const sS=db.series.filter(r=>r.sagaId===sg.id).sort((a,b)=>a.name.localeCompare(b.name)); if(sS.length===0) return "";
      return `<div class="card"><h3 style="color:var(--main)">${sg.name}</h3>${sS.map(sr=>{ 
          const aN=db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===gid).map(v=>v.number).sort((a,b)=>a-b); 
          return `<div class="row-edit" style="border:none"><img src="${sr.img}" class="cover-big"><div><b style="font-size:20px">${sr.name}</b><br><span class="small">${sr.authors} | ${sr.publisher} (${sr.status})</span><br><div style="margin-top:10px">${aN.map(n=>`<span class="volumeStatic" style="margin:2px">${n}</span>`).join('')}</div></div></div>`; 
      }).join('')}</div>`; 
  }).join('');
}
function readTab(c){
  const gid=getActiveGroup(); const sortedSagas = db.sagas.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name));
  c.innerHTML=`<h2 class="section-title">Lettura</h2><div class="card"><select id="readSagaSelect" onchange="renderReadList()"><option value="">-- Seleziona Saga (A-Z) --</option>${sortedSagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select></div><div id="readArea"></div>`;
}
window.renderReadList=()=>{
  const sagaId=document.getElementById("readSagaSelect").value; if(!sagaId)return;
  const user=db.users.find(u=>u.id===db.currentUser); const groupMembers = db.users.filter(u => u.groupId === user.groupId);
  document.getElementById("readArea").innerHTML=db.series.filter(s=>s.sagaId===sagaId).sort((a,b)=>a.name.localeCompare(b.name)).map(sr=>{
    const myGroupVols=db.volumes.filter(v=>v.seriesId===sr.id && v.groupId===user.groupId).sort((a,b)=>a.number-b.number);
    return `<div class="card"><div class="row-edit" style="border:none"><img src="${sr.img}" class="cover-big"><div style="flex:1"><h3>${sr.name}</h3><p class="small">${sr.authors} | ${sr.publisher}</p><div style="display:flex;flex-wrap:wrap;margin-top:10px">${myGroupVols.map(v=>{
            const amIRead=db.read.some(r=>r.volId===v.id && r.userId===user.id);
            const dots = groupMembers.map(m => {
                const hasRead = db.read.some(r => r.volId === v.id && r.userId === m.id);
                return hasRead ? `<span class="dot" style="background-color:${m.color}" title="${m.name}"></span>` : '';
            }).join('');
            return `<div class="vol-container"><button class="volumeBtn" style="${amIRead?`background:${user.color};color:white;border:none`:''}" onclick="toggleRead('${v.id}')">${v.number}</button><div class="read-indicators">${dots}</div></div>`;
    }).join('')}</div></div></div></div>`;
  }).join('');
}
window.toggleRead=(volId)=>{ const idx=db.read.findIndex(r=>r.volId===volId && r.userId===db.currentUser); if(idx>-1) db.read.splice(idx,1); else db.read.push({volId, userId:db.currentUser}); save(); renderReadList(); }
function addVolumes(c){
  const gid = getActiveGroup();
  const series = db.series.filter(s => s.groupId === gid).sort((a,b)=>a.name.localeCompare(b.name));
  c.innerHTML=`<h2 class="section-title">Aggiungi Numeri</h2><div class="card"><select id="vSerie" onchange="showUserVols()"><option value="">-- Seleziona Serie (A-Z) --</option>${series.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select><div id="seriePreview" style="margin-top:15px"></div><div id="vInputArea" style="display:none"><div class="row-edit" style="border:none; padding:0"><input type="number" id="vStart" placeholder="Dal n."><input type="number" id="vEnd" placeholder="Al n."></div><button class="ok" style="width:100%; margin-top:10px" onclick="saveVols()">Aggiungi</button></div><div id="vList"></div>`;
}
function showUserVols(){
  const sid=document.getElementById("vSerie").value; if(!sid)return; const sr=db.series.find(x=>x.id===sid);
  document.getElementById("vInputArea").style.display="block";
  document.getElementById("seriePreview").innerHTML=`<div class="row-edit" style="border:none"><img src="${sr.img}" class="cover-big"><div><h3>${sr.name}</h3><p class="small">${sr.authors}</p></div></div>`;
  const groupVols=db.volumes.filter(v=>v.seriesId===sid && v.groupId===getActiveGroup()).sort((a,b)=>a.number-b.number);
  document.getElementById("vList").innerHTML=`<div class="card"><h4>Collezione Gruppo:</h4><div style="display:flex;flex-wrap:wrap">${groupVols.map(v=>`<button class="volumeBtn" style="margin:2px" onclick="removeVol('${v.id}')">${v.number}</button>`).join('')}</div></div>`;
}
window.removeVol=(id)=>{ db.volumes=db.volumes.filter(v=>v.id!==id); db.read=db.read.filter(r=>r.volId!==id); save(); showUserVols(); }
function addSeries(c){
  const gid = getActiveGroup();
  const sortedSagas = db.sagas.filter(s=>s.groupId===gid).sort((a,b)=>a.name.localeCompare(b.name));
  c.innerHTML = `<h2 class="section-title">Gestione Serie</h2>
    <div class="card"><h3>Crea Saga</h3><input id="sagaNameOnly" placeholder="Nome Saga"><button class="ok" onclick="createSagaOnly()">Crea</button></div>
    <div class="card"><h3>Aggiungi Serie</h3>
      <input id="nsTitolo" placeholder="Titolo"><select id="nsSagaSelect"><option value="NEW">Nuova Saga</option>${sortedSagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
      <input id="nsAutore" placeholder="Autore"><input id="nsEditore" placeholder="Editore"><input id="nsImg" placeholder="URL Immagine">
      <select id="nsStatus"><option value="In Corso">In Corso</option><option value="Terminata">Terminata</option><option value="Interrotta">Interrotta</option></select>
      <button class="ok" onclick="createSerieFull()">Salva</button>
    </div>
    <h2 class="section-title">Modifica</h2>
    <div class="card"><select id="selectSagaEdit" onchange="renderEditArea()"><option value="">-- Seleziona Saga (A-Z) --</option>${sortedSagas.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select><div id="editArea"></div></div>`;
}
window.renderEditArea=()=>{
    const sagaId=document.getElementById("selectSagaEdit").value; const area=document.getElementById("editArea"); if(!sagaId){area.innerHTML="";return;}
    const saga=db.sagas.find(s=>s.id===sagaId); const seriesInSaga = db.series.filter(s=>s.sagaId===sagaId).sort((a,b)=>a.name.localeCompare(b.name));
    const allSagas = db.sagas.filter(s=>s.groupId===getActiveGroup()).sort((a,b)=>a.name.localeCompare(b.name));
    let h=`<div class="card"><label>Rinomina Saga:</label><input id="editSagaName" value="${saga.name}"><button class="ok" onclick="updateSaga('${saga.id}')">Salva</button></div>`;
    seriesInSaga.forEach(sr=>{
        h+=`<div class="card"><div class="row-edit"><img src="${sr.img}" class="cover-big"><div style="flex:1"><input id="t-${sr.id}" value="${sr.name}"><input id="a-${sr.id}" value="${sr.authors}" class="small"><input id="e-${sr.id}" value="${sr.publisher}" class="small"><select id="st-${sr.id}"><option value="In Corso" ${sr.status==='In Corso'?'selected':''}>In Corso</option><option value="Terminata" ${sr.status==='Terminata'?'selected':''}>Terminata</option><option value="Interrotta" ${sr.status==='Interrotta'?'selected':''}>Interrotta</option></select><label class="small">Sposta Saga:</label><select id="m-${sr.id}">${allSagas.map(s=>`<option value="${s.id}" ${s.id===sagaId?'selected':''}>${s.name}</option>`).join('')}</select><div style="margin-top:10px"><button class="ok" onclick="updateFullSerie('${sr.id}')">Salva</button> <button class="danger" onclick="deleteSerie('${sr.id}')">Elimina</button></div></div></div></div>`;
    }); area.innerHTML=h;
}
function users(c){
  c.innerHTML = "<h2 class='section-title'>Gruppi</h2><div class='card'><input id='newGroupName' placeholder='Nome Gruppo'><button class='ok' onclick='addGroup()'>Crea</button></div>";
  db.groups.forEach(g => { c.innerHTML += `<div class="card" style="display:flex; gap:10px"><input value="${g.name}" onchange="updateGroupName('${g.id}',this.value)" style="flex:1">${g.id!=='default'?`<button class="danger" onclick="deleteGroup('${g.id}')">X</button>`:''}</div>`; });
  c.innerHTML += "<h2 class='section-title'>Profili</h2>";
  db.users.forEach(u => { c.innerHTML += `<div class="card"><input id="un-${u.id}" value="${u.name}"> <input id="uc-${u.id}" type="color" value="${u.color}"><select id="ug-${u.id}">${db.groups.map(g=>(`<option value="${g.id}" ${u.groupId===g.id?'selected':''}>${g.name}</option>`)).join('')}</select><div style="margin-top:10px"><button class="ok" onclick="updateUserProfile('${u.id}')">Salva</button> <button class="danger" onclick="deleteUser('${u.id}')">Elimina</button></div></div>`; });
  c.innerHTML += `<div class="card"><h3>Nuovo Utente</h3><input id="newUserName" placeholder="Nome Profilo"><select id="newUserGroup">${db.groups.map(g=>(`<option value="${g.id}">${g.name}</option>`)).join('')}</select><button class="ok" style="margin-top:10px" onclick="addNewUser()">Crea Utente</button></div>`;
}

/* API MOCKUP */
window.addNewUser=()=>{ const name=document.getElementById("newUserName").value; if(!name)return; const gid=document.getElementById("newUserGroup").value; db.users.push({id:crypto.randomUUID(), name, color:"#6c5ce7", groupId:gid}); save(); users(app); }
window.deleteUser=(id)=>{ if(confirm("Eliminare?")){ db.users=db.users.filter(u=>u.id!==id); save(); users(app); }}
window.createSagaOnly=()=>{ const n=document.getElementById("sagaNameOnly").value.trim(); if(!n)return; db.sagas.push({id:crypto.randomUUID(), name:n, groupId:getActiveGroup()}); save(); addSeries(app); }
window.createSerieFull=()=>{ const name=document.getElementById("nsTitolo").value.trim(); if(!name)return; let sagaId=document.getElementById("nsSagaSelect").value; const gid=getActiveGroup(); if(sagaId==="NEW"){ const ns={id:crypto.randomUUID(), name, groupId:gid}; db.sagas.push(ns); sagaId=ns.id; } db.series.push({id:crypto.randomUUID(), name, sagaId, groupId:gid, authors:document.getElementById("nsAutore").value, publisher:document.getElementById("nsEditore").value, img:document.getElementById("nsImg").value, status:document.getElementById("nsStatus").value}); save(); addSeries(app); }
window.updateFullSerie=(id)=>{ const s=db.series.find(x=>x.id===id); s.name=document.getElementById(`t-${id}`).value; s.authors=document.getElementById(`a-${id}`).value; s.publisher=document.getElementById(`e-${id}`).value; s.status=document.getElementById(`st-${id}`).value; s.sagaId=document.getElementById(`m-${id}`).value; save(); renderEditArea(); }
window.updateSaga=(id)=>{ db.sagas.find(x=>x.id===id).name=document.getElementById("editSagaName").value; save(); renderEditArea(); }
window.deleteSerie=(id)=>{ if(confirm("Eliminare la serie?")){ db.series=db.series.filter(s=>s.id!==id); db.volumes=db.volumes.filter(v=>v.seriesId!==id); save(); renderEditArea(); }}
window.addGroup=()=>{ const n=document.getElementById("newGroupName").value; if(!n)return; db.groups.push({id:crypto.randomUUID(), name:n}); save(); users(app); }
window.updateGroupName=(id,v)=>{ db.groups.find(g=>g.id===id).name=v; save(); }
window.updateUserProfile=(id)=>{ const u=db.users.find(x=>x.id===id); u.name=document.getElementById(`un-${id}`).value; u.color=document.getElementById(`uc-${id}`).value; u.groupId=document.getElementById(`ug-${id}`).value; save(); users(app); }
window.saveVols=()=>{
  const sid=document.getElementById("vSerie").value, start=Number(document.getElementById("vStart").value), end=Number(document.getElementById("vEnd").value)||start;
  const gid=getActiveGroup(); for(let i=start;i<=end;i++){ if(!db.volumes.find(v=>v.seriesId===sid && v.number===i && v.groupId===gid)) db.volumes.push({id:crypto.randomUUID(), seriesId:sid, number:i, userId:db.currentUser, groupId:gid}); }
  save(); showUserVols();
}

render();
</script>
</body>
</html>
