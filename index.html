<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;--bg:#f5f6fa;}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
header{background:var(--main);color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;}
nav button{border:none;padding:10px 14px;border-radius:6px;cursor:pointer;height:40px;}
main{padding:12px;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;}
.row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap;}
.cover{width:60px;height:80px;object-fit:cover;border-radius:4px;background:#ccc;}
.small{font-size:12px;color:#555;}
.ok{background:var(--main);color:#fff;}
.danger{background:#e74c3c;color:#fff;}
input,select{width:100%;padding:6px;margin:4px 0;}
.volume{display:inline-block;padding:6px 10px;margin:4px;background:#eee;border-radius:4px;}
</style>
</head>

<body>

<header>
  <div>
    <h1 style="margin:0">MangaNest</h1>
    <div id="who" class="small"></div>
  </div>
  <button id="switchUser" style="display:none;">Cambia utente</button>
</header>

<nav id="menu"></nav>
<main id="app"></main>

<script>
let db = JSON.parse(localStorage.getItem("manganest")) || {
  users:[
    {id:"simone",name:"Simone",color:"#6c5ce7"},
    {id:"andrea",name:"Andrea",color:"#e84393"}
  ],
  currentUser:null,
  sagas:[],
  series:[],
  volumes:[]
};

function save(){ localStorage.setItem("manganest",JSON.stringify(db)); }

const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

switchBtn.onclick=()=>{ db.currentUser=null; save(); render(); };

function render(){
  const u=db.users.find(x=>x.id===db.currentUser);
  document.documentElement.style.setProperty("--main", u?.color || "#6c5ce7");
  who.textContent=u?("Utente: "+u.name):"";
  switchBtn.style.display=u?"inline-block":"none";

  menu.innerHTML="";
  if(!db.currentUser){ home(); return; }

  [
    ["Database",database],
    ["Aggiungi numeri",addVolumes],
    ["Lettura",lettura],
    ["Utenti",users]
  ].forEach(([t,f])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.onclick=()=>f(app);
    menu.appendChild(b);
  });

  database(app);
}

function home(){
  app.innerHTML="<h2>Scegli utente</h2>";
  db.users.forEach(u=>{
    const b=document.createElement("button");
    b.textContent=u.name;
    b.style.background=u.color;
    b.style.color="#fff";
    b.onclick=()=>{ db.currentUser=u.id; save(); render(); };
    app.appendChild(b);
  });
}

/* ================= UTENTI ================= */
function users(c){
  c.innerHTML="<h2>Utenti</h2>";
  db.users.forEach(u=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <input value="${u.name}">
      <input type="color" value="${u.color}">
      <button class="ok">Salva</button>
      <button class="danger">Elimina</button>
    `;
    d.querySelector(".ok").onclick=()=>{
      u.name=d.querySelector("input").value.trim();
      u.color=d.querySelector("input[type=color]").value;
      save(); render();
    };
    d.querySelector(".danger").onclick=()=>{
      if(confirm("Eliminare utente?")){
        db.users=db.users.filter(x=>x.id!==u.id);
        if(db.currentUser===u.id) db.currentUser=null;
        save(); render();
      }
    };
    c.appendChild(d);
  });
}

/* ================= DATABASE ================= */
function database(c){
  c.innerHTML="<h2>Database</h2>";

  // NUOVA SAGA
  const ns=document.createElement("div");
  ns.className="card";
  ns.innerHTML=`<h3>Nuova saga</h3><input id="ns"><button class="ok">Aggiungi</button>`;
  ns.querySelector("button").onclick=()=>{
    const v=ns.querySelector("#ns").value.trim();
    if(v && !db.sagas.find(x=>x.name===v)){
      db.sagas.push({id:crypto.randomUUID(),name:v});
      save(); render();
    }
  };
  c.appendChild(ns);

  // NUOVA SERIE
  const ss=document.createElement("div");
  ss.className="card";
  ss.innerHTML=`
    <h3>Nuova serie</h3>
    <input id="n" placeholder="Nome">
    <select id="sg">
      <option value="">Nessuna saga</option>
      ${db.sagas.sort((a,b)=>a.name.localeCompare(b.name))
        .map(x=>`<option value="${x.id}">${x.name}</option>`)}
    </select>
    <select id="st">
      <option>in corso</option>
      <option>finita</option>
      <option>interrotta</option>
    </select>
    <input id="au" placeholder="Autori">
    <input id="ed" placeholder="Editore">
    <input id="im" placeholder="URL immagine">
    <button class="ok">Aggiungi</button>
  `;
  ss.querySelector("button").onclick=()=>{
    const name=ss.querySelector("#n").value.trim();
    if(!name) return;
    let sagaId=ss.querySelector("#sg").value;
    if(!sagaId){
      const g={id:crypto.randomUUID(),name};
      db.sagas.push(g); sagaId=g.id;
    }
    db.series.push({
      id:crypto.randomUUID(),
      name,
      sagaId,
      status:ss.querySelector("#st").value,
      authors:ss.querySelector("#au").value,
      publisher:ss.querySelector("#ed").value,
      img:ss.querySelector("#im").value
    });
    save(); render();
  };
  c.appendChild(ss);

  // RECAP
  db.sagas.sort((a,b)=>a.name.localeCompare(b.name)).forEach(g=>{
    const box=document.createElement("div");
    box.className="card";
    box.innerHTML=`<h3>${g.name}</h3>`;
    db.series.filter(s=>s.sagaId===g.id)
      .sort((a,b)=>a.name.localeCompare(b.name))
      .forEach(sr=>{
        const r=document.createElement("div");
        r.className="row";
        r.innerHTML=`
          <img class="cover" src="${sr.img||'https://via.placeholder.com/60x80'}">
          <div>
            <b>${sr.name}</b><br>
            <span class="small">${sr.status} – ${sr.publisher||""}</span>
          </div>
        `;
        box.appendChild(r);
      });
    c.appendChild(box);
  });
}

/* ================= AGGIUNGI VOLUMI ================= */
function addVolumes(c){
  c.innerHTML="<h2>Aggiungi numeri</h2>";
  if(db.series.length===0){ c.innerHTML+="<p>Nessuna serie</p>"; return; }

  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <select id="s">${db.series.sort((a,b)=>a.name.localeCompare(b.name))
      .map(x=>`<option value="${x.id}">${x.name}</option>`)}</select>
    <input id="da" type="number" placeholder="Dal numero">
    <input id="a" type="number" placeholder="Al numero (facoltativo)">
    <button class="ok">Aggiungi</button>
    <div id="out"></div>
  `;
  c.appendChild(card);

  card.querySelector("button").onclick=()=>{
    const sid=card.querySelector("#s").value;
    let da=+card.querySelector("#da").value;
    let a=+card.querySelector("#a").value || da;
    for(let i=da;i<=a;i++){
      if(!db.volumes.find(v=>v.series===sid && v.number===i)){
        db.volumes.push({series:sid,number:i});
      }
    }
    save();
    showSeriesVolumes(card.querySelector("#out"),sid);
  };
}

/* ================= LETTURA (STEP 1) ================= */
function lettura(c){
  c.innerHTML="<h2>Lettura</h2>";

  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <label>Saga</label>
    <select id="lsaga">
      <option value="">— seleziona saga —</option>
      ${db.sagas.sort((a,b)=>a.name.localeCompare(b.name))
        .map(x=>`<option value="${x.id}">${x.name}</option>`)}
    </select>

    <label>Serie</label>
    <select id="lserie">
      <option value="">— seleziona serie —</option>
      ${db.series.sort((a,b)=>a.name.localeCompare(b.name))
        .map(x=>`<option value="${x.id}">${x.name}</option>`)}
    </select>

    <div id="lvols"></div>
  `;
  c.appendChild(card);

  const out=card.querySelector("#lvols");

  card.querySelector("#lsaga").onchange=e=>{
    const sid=e.target.value;
    out.innerHTML="";
    if(!sid) return;
    db.series.filter(s=>s.sagaId===sid).forEach(sr=>{
      db.volumes.filter(v=>v.series===sr.id)
        .sort((a,b)=>a.number-b.number)
        .forEach(v=>{
          const d=document.createElement("span");
          d.className="volume";
          d.textContent=`${sr.name} #${v.number}`;
          out.appendChild(d);
        });
    });
  };

  card.querySelector("#lserie").onchange=e=>{
    const sid=e.target.value;
    out.innerHTML="";
    if(!sid) return;
    const sr=db.series.find(s=>s.id===sid);
    db.volumes.filter(v=>v.series===sid)
      .sort((a,b)=>a.number-b.number)
      .forEach(v=>{
        const d=document.createElement("span");
        d.className="volume";
        d.textContent=`${sr.name} #${v.number}`;
        out.appendChild(d);
      });
  };
}

render();
</script>

</body>
</html>
