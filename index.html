<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MangaNest</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">

<div id="root"></div>

<script type="text/babel">

const { useState } = React;

function App() {
  const [readers, setReaders] = useState([
    { name: "Simone", color: "green" },
    { name: "Andrea", color: "yellow" }
  ]);
  const [currentReader, setCurrentReader] = useState(readers[0].name);

  const [sagas, setSagas] = useState([]);
  const [series, setSeries] = useState([]);
  const [newSaga, setNewSaga] = useState("");
  const [newSeries, setNewSeries] = useState("");

  // AGGIUNGI SAGHE
  const addSaga = () => {
    if (!newSaga.trim()) return;
    setSagas([...sagas, { name: newSaga, favoriteBy: [] }]);
    setNewSaga("");
  };

  // AGGIUNGI SERIE
  const addSeries = () => {
    if (!newSeries.trim()) return;
    setSeries([
      ...series,
      {
        name: newSeries,
        saga: null,
        status: "in corso",
        authors: [],
        publisher: "",
        orderIndex: series.length,
        volumes: [],
        favoriteBy: []
      }
    ]);
    setNewSeries("");
  };

  // AGGIUNGI VOLUMI (singolo o intervallo)
  const addVolume = (sIndex) => {
    const volNum = prompt("Numero volume singolo o intervallo (es. 1 o 3-7 o 0 o 0.5)");
    if (!volNum) return;
    const updated = [...series];
    if (volNum.includes("-")) {
      const [start, end] = volNum.split("-").map(Number);
      for (let i = Math.min(start,end); i <= Math.max(start,end); i++) {
        if (!updated[sIndex].volumes.find(v => v.number===i))
          updated[sIndex].volumes.push({number:i, read:{}, isLast:false});
      }
    } else {
      const n = Number(volNum);
      if (!updated[sIndex].volumes.find(v => v.number===n))
        updated[sIndex].volumes.push({number:n, read:{}, isLast:false});
    }
    setSeries(updated);
  };

  // TOGGLE LETTURA
  const toggleRead = (sIndex, vIndex) => {
    const updated = [...series];
    const vol = updated[sIndex].volumes[vIndex];
    vol.read[currentReader] = !vol.read[currentReader];
    setSeries(updated);
  };

  // SEGNA TUTTI LETTI
  const markAllRead = (sIndex) => {
    const updated = [...series];
    updated[sIndex].volumes.forEach(v => v.read[currentReader]=true);
    setSeries(updated);
  };

  // CUORI SERIE/SAGA
  const toggleFavoriteSeries = (sIndex) => {
    const updated = [...series];
    const favIndex = updated[sIndex].favoriteBy.indexOf(currentReader);
    if(favIndex===-1) updated[sIndex].favoriteBy.push(currentReader);
    else updated[sIndex].favoriteBy.splice(favIndex,1);
    setSeries(updated);
  };
  const toggleFavoriteSaga = (sIndex) => {
    const updated = [...sagas];
    const favIndex = updated[sIndex].favoriteBy.indexOf(currentReader);
    if(favIndex===-1) updated[sIndex].favoriteBy.push(currentReader);
    else updated[sIndex].favoriteBy.splice(favIndex,1);
    setSagas(updated);
  };

  // FLAG ULTIMO VOLUME
  const toggleLastVolume = (sIndex, vIndex) => {
    const updated = [...series];
    updated[sIndex].volumes.forEach(v => v.isLast=false);
    updated[sIndex].volumes[vIndex].isLast = true;
    updated[sIndex].status = "finita";
    setSeries(updated);
  };

  const lastVolumeNumber = (s) => s.volumes.length ? Math.max(...s.volumes.map(v=>v.number)) : 0;

  return (
    <div className="p-4 max-w-4xl mx-auto space-y-4 font-sans">

      <h1 className="text-3xl font-bold">MangaNest</h1>

      <div className="flex gap-2">
        <input className="border rounded px-2 py-1" placeholder="Nuova saga" value={newSaga} onChange={e=>setNewSaga(e.target.value)}/>
        <button className="bg-blue-500 text-white px-3 rounded" onClick={addSaga}>+ Saga</button>
      </div>

      <div className="flex gap-2">
        <input className="border rounded px-2 py-1" placeholder="Nuova serie" value={newSeries} onChange={e=>setNewSeries(e.target.value)}/>
        <button className="bg-green-500 text-white px-3 rounded" onClick={addSeries}>+ Serie</button>
      </div>

      {series.map((s,sIndex)=>(
        <div key={sIndex} className="border rounded p-3 space-y-2 shadow-md bg-white">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-semibold">{s.name} {s.favoriteBy.includes(currentReader)?"‚ù§Ô∏è":""}</h2>
            <div className="flex gap-2">
              <button className="bg-gray-200 px-2 rounded" onClick={()=>markAllRead(sIndex)}>Segna tutta letta</button>
              <button className="bg-gray-200 px-2 rounded" onClick={()=>addVolume(sIndex)}>+ Volume/i</button>
              <button className="bg-gray-200 px-2 rounded" onClick={()=>toggleFavoriteSeries(sIndex)}>‚ù§Ô∏è Serie</button>
            </div>
          </div>

          <div className="flex gap-4 text-sm">
            <span>Stato: {s.status}</span>
            <span>Editore: {s.publisher}</span>
            <span>Autori: {s.authors.join(", ")}</span>
          </div>

          {s.volumes.map((v,vIndex)=>(
            <div key={vIndex} className="flex items-center justify-between border rounded p-2">
              <span>Volume {v.number} {v.isLast?"(Ultimo)":""}</span>
              <div className="flex gap-4 items-center">
                <label className="flex items-center gap-1">
                  <input type="checkbox" checked={v.read[currentReader]||false} onChange={()=>toggleRead(sIndex,vIndex)}/> {currentReader}
                </label>
                <button className="bg-red-200 px-2 rounded" onClick={()=>toggleLastVolume(sIndex,vIndex)}>Ultimo</button>
              </div>
            </div>
          ))}

        </div>
      ))}

      <div className="border rounded p-3 shadow-md bg-white">
        <h2 className="text-xl font-semibold">üè™ Volumi mancanti</h2>
        {series.map((s)=>{
          const missing = s.volumes.filter(v => !v.read[readers[0].name] || !v.read[readers[1].name]);
          if(missing.length===0) return null;
          return (
            <div key={s.name} className="mb-2">
              <strong>{s.name}</strong>: {missing.map(v=>v.number).join(", ")} (ultimo volume registrato: {lastVolumeNumber(s)})
            </div>
          )
        })}
      </div>

      <div className="border rounded p-3 shadow-md bg-white">
        <button className="bg-purple-500 text-white px-3 py-1 rounded"
          onClick={()=>{
            const csv = series.map(s=>s.volumes.map(v=>`${s.name},${v.number},${Object.keys(v.read).filter(r=>v.read[r]).join("|")},${s.status},${s.authors.join("|")},${s.publisher},${v.isLast}`).join("\n")).join("\n");
            const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download","manga_backup.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }}
