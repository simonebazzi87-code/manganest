<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MangaNest</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#6c5ce7;--bg:#f5f6fa;}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
header{background:var(--main);color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;}
nav{display:flex;gap:8px;padding:10px;background:#fff;flex-wrap:wrap;}
nav button{border:none;padding:10px 14px;border-radius:6px;cursor:pointer;height:40px;}
main{padding:12px;}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.cover{width:60px;height:80px;object-fit:cover;border-radius:4px;background:#ccc;}
.volume{padding:6px 10px;margin:4px;border-radius:4px;background:#eee;border:none;}
.flag{width:16px;height:16px;border:2px solid #999;border-radius:4px;margin:2px;cursor:pointer;}
.flag.disabled{opacity:.3;cursor:not-allowed;}
.small{font-size:12px;color:#555;}
.ok{background:var(--main);color:#fff;}
.danger{background:#e74c3c;color:#fff;}
input,select{width:100%;padding:6px;margin:4px 0;}
</style>
</head>

<body>

<header>
  <div>
    <h1 style="margin:0">MangaNest</h1>
    <div id="who" class="small"></div>
  </div>
  <button id="switchUser" style="display:none;">Cambia utente</button>
</header>

<nav id="menu"></nav>
<main id="app"></main>

<script>
let db = JSON.parse(localStorage.getItem("manganest")) || {
  users:[
    {id:"simone",name:"Simone",color:"#6c5ce7"},
    {id:"andrea",name:"Andrea",color:"#e84393"}
  ],
  currentUser:null,
  sagas:[],
  series:[],
  volumes:[],
  readings:[]
};

function save(){ localStorage.setItem("manganest",JSON.stringify(db)); }

const app=document.getElementById("app");
const menu=document.getElementById("menu");
const who=document.getElementById("who");
const switchBtn=document.getElementById("switchUser");

switchBtn.onclick=()=>{ db.currentUser=null; save(); render(); };

function render(){
  const u=db.users.find(x=>x.id===db.currentUser);
  document.documentElement.style.setProperty("--main", u?.color || "#6c5ce7");
  who.textContent=u?("Utente: "+u.name):"";
  switchBtn.style.display=u?"inline-block":"none";

  menu.innerHTML="";
  if(!db.currentUser){ home(); return; }

  [["Database",database],["Aggiungi numeri",addVolumes],["Lettura",lettura],["Utenti",users]]
    .forEach(([t,f])=>{
      const b=document.createElement("button");
      b.textContent=t;
      b.onclick=()=>f(app);
      menu.appendChild(b);
    });

  database(app);
}

function home(){
  app.innerHTML="<h2>Scegli utente</h2>";
  db.users.forEach(u=>{
    const b=document.createElement("button");
    b.textContent=u.name;
    b.style.background=u.color;
    b.style.color="#fff";
    b.onclick=()=>{ db.currentUser=u.id; save(); render(); };
    app.appendChild(b);
  });
}

/* ================= UTENTI ================= */
function users(c){
  c.innerHTML="<h2>Utenti</h2>";
  db.users.forEach(u=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <input value="${u.name}">
      <input type="color" value="${u.color}">
      <button class="ok">Salva</button>
    `;
    d.querySelector(".ok").onclick=()=>{
      u.name=d.querySelector("input").value.trim();
      u.color=d.querySelector("input[type=color]").value;
      save(); render();
    };
    c.appendChild(d);
  });
}

/* ================= DATABASE (ripristinato) ================= */
function database(c){
  c.innerHTML="<h2>Database</h2>";

  // nuova saga
  const sg=document.createElement("div");
  sg.className="card";
  sg.innerHTML=`<input id="ns" placeholder="Nuova saga"><button class="ok">Aggiungi</button>`;
  sg.querySelector("button").onclick=()=>{
    const v=sg.querySelector("#ns").value.trim();
    if(v && !db.sagas.find(x=>x.name===v)){
      db.sagas.push({id:crypto.randomUUID(),name:v});
      save(); render();
    }
  };
  c.appendChild(sg);

  db.sagas.sort((a,b)=>a.name.localeCompare(b.name)).forEach(g=>{
    const box=document.createElement("div");
    box.className="card";
    box.innerHTML=`<h3>${g.name}</h3>`;
    db.series.filter(s=>s.sagaId===g.id)
      .sort((a,b)=>a.name.localeCompare(b.name))
      .forEach(sr=>{
        box.innerHTML+=`<div class="small">ðŸ“˜ ${sr.name}</div>`;
      });
    c.appendChild(box);
  });
}

/* ================= HELPER LETTURA ================= */
function isRead(userId, seriesId, num){
  return db.readings.find(r=>r.userId===userId && r.seriesId===seriesId && r.volumeNumber===num);
}

/* ================= LETTURA ================= */
function lettura(c){
  c.innerHTML="<h2>Lettura</h2>";
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <select id="serie">
      <option value="">â€” seleziona serie â€”</option>
      ${db.series.sort((a,b)=>a.name.localeCompare(b.name))
        .map(s=>`<option value="${s.id}">${s.name}</option>`)}
    </select>
    <div id="out"></div>
  `;
  c.appendChild(card);

  const out=card.querySelector("#out");

  card.querySelector("#serie").onchange=()=>{
    out.innerHTML="";
    const sid=card.querySelector("#serie").value;
    if(!sid) return;

    const sr=db.series.find(s=>s.id===sid);
    const vols=db.volumes.filter(v=>v.series===sid).sort((a,b)=>a.number-b.number);

    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`<img class="cover" src="${sr.img||'https://via.placeholder.com/60x80'}"><b>${sr.name}</b>`;
    out.appendChild(row);

    vols.forEach(v=>{
      const line=document.createElement("div");
      line.className="row";
      line.innerHTML=`<span class="volume">${v.number}</span>`;

      db.users.forEach(u=>{
        const f=document.createElement("div");
        f.className="flag"+(u.id!==db.currentUser?" disabled":"");
        if(isRead(u.id,sid,v.number)) f.style.background=u.color;

        f.onclick=()=>{
          if(u.id!==db.currentUser) return;
          const idx=db.readings.findIndex(r=>r.userId===u.id && r.seriesId===sid && r.volumeNumber===v.number);
          if(idx>-1) db.readings.splice(idx,1);
          else db.readings.push({userId:u.id,seriesId:sid,volumeNumber:v.number});
          save();
          card.querySelector("#serie").onchange();
        };
        line.appendChild(f);
      });
      out.appendChild(line);
    });
  };
}

/* ================= AGGIUNGI NUMERI ================= */
function addVolumes(c){
  c.innerHTML="<h2>Aggiungi numeri</h2>";
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <select id="s">${db.series.sort((a,b)=>a.name.localeCompare(b.name))
      .map(x=>`<option value="${x.id}">${x.name}</option>`)}</select>
    <input id="da" type="number" placeholder="Dal numero">
    <input id="a" type="number" placeholder="Al numero">
    <button class="ok">Aggiungi</button>
  `;
  c.appendChild(card);

  card.querySelector("button").onclick=()=>{
    const sid=card.querySelector("#s").value;
    let da=+card.querySelector("#da").value;
    let a=+card.querySelector("#a").value||da;
    for(let i=da;i<=a;i++){
      if(db.volumes.find(v=>v.series===sid && v.number===i)){
        alert("Volume "+i+" giÃ  presente");
        continue;
      }
      db.volumes.push({series:sid,number:i});
    }
    save();
  };
}

render();
</script>
</body>
</html>
